<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="theme-color" content="#D4AF37">
    <title>نظام إدارة الحضور والانصراف - نخبة العود</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap');
        
        /* Login System Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            animation: loginBackgroundFloat 20s ease-in-out infinite;
        }
        
        @keyframes loginBackgroundFloat {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
        }
        
        .login-container.hidden {
            display: none;
        }
        
        .login-card {
            background: rgba(212, 175, 55, 0.08);
            backdrop-filter: blur(30px);
            border: 2px solid var(--oud-gold);
            border-radius: 30px;
            padding: 50px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 40px rgba(212, 175, 55, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: loginCardAppear 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--oud-gold), var(--oud-amber), var(--oud-bronze), var(--oud-gold));
            border-radius: 32px;
            z-index: -1;
            animation: loginBorderGlow 3s ease-in-out infinite;
        }
        
        @keyframes loginBorderGlow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes loginCardAppear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .login-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: logoGlow 2s ease-in-out infinite;
        }
        
        @keyframes logoGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.6));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(255, 191, 0, 0.8));
                transform: scale(1.05);
            }
        }
        
        .login-title {
            color: var(--oud-gold);
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--oud-cream);
            font-size: 1rem;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-input-group {
            position: relative;
        }
        
        .login-input {
            width: 100%;
            padding: 18px 25px 18px 55px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 18px;
            background: rgba(245, 245, 220, 0.05);
            color: var(--oud-cream);
            font-family: 'Cairo', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .login-input::placeholder {
            color: rgba(245, 245, 220, 0.6);
            font-weight: 400;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--oud-gold);
            background: rgba(245, 245, 220, 0.12);
            box-shadow: 
                0 0 30px rgba(212, 175, 55, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .login-input:valid {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        
        .login-input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--oud-gold);
            font-size: 1.4rem;
            transition: all 0.3s ease;
            z-index: 5;
        }
        
        .login-input-group:focus-within .login-input-icon {
            color: var(--oud-amber);
            transform: translateY(-50%) scale(1.1);
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));
        }
        
        .login-btn {
            padding: 18px 40px;
            background: var(--gradient-primary);
            color: var(--oud-black);
            border: none;
            border-radius: 18px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .login-btn:hover::before {
            left: 100%;
        }
        
        .login-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(212, 175, 55, 0.5);
        }
        
        .login-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .login-error {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            display: none;
        }
        
        .demo-credentials {
            margin-top: 20px;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            border: 1px solid var(--oud-gold);
        }
        
        .demo-title {
            color: var(--oud-gold);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .demo-user {
            color: var(--oud-cream);
            font-size: 0.9rem;
            margin: 5px 0;
        }
        
        :root {
            /* نخبة العود - الألوان الفاخرة */
            --oud-gold: #D4AF37;
            --oud-gold-light: #F4E4A6;
            --oud-gold-dark: #B8941F;
            --oud-brown: #8B4513;
            --oud-brown-light: #CD853F;
            --oud-brown-dark: #654321;
            --oud-cream: #F5F5DC;
            --oud-black: #1C1C1C;
            --oud-white: #FEFEFE;
            --oud-bronze: #CD7F32;
            --oud-amber: #FFBF00;
            
            /* الألوان الأساسية */
            --primary: var(--oud-gold);
            --secondary: var(--oud-brown);
            --accent: var(--oud-amber);
            --success: #2D5016;
            --warning: #8B4513;
            --error: #722F37;
            --info: var(--oud-bronze);
            
            /* التدرجات الفاخرة */
            --gradient-primary: linear-gradient(135deg, var(--oud-gold) 0%, var(--oud-amber) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--oud-brown) 0%, var(--oud-brown-dark) 100%);
            --gradient-luxury: linear-gradient(135deg, var(--oud-gold) 0%, var(--oud-bronze) 50%, var(--oud-brown) 100%);
            --gradient-elegant: linear-gradient(135deg, var(--oud-cream) 0%, var(--oud-gold-light) 100%);
            
            /* الزجاج المورف الفاخر */
            --glass-bg: rgba(212, 175, 55, 0.15);
            --glass-border: rgba(212, 175, 55, 0.25);
            --shadow-luxury: 0 8px 32px rgba(212, 175, 55, 0.2);
            --shadow-elegant: 0 12px 40px rgba(139, 69, 19, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--oud-brown) 0%, var(--oud-brown-dark) 30%, var(--oud-black) 70%, #0F0F0F 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* خلفية نخبة العود المتحركة الفاخرة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(205, 127, 50, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 191, 0, 0.2) 0%, transparent 50%);
            animation: oudBackgroundMove 25s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes oudBackgroundMove {
            0%, 100% { transform: translateX(0) translateY(0) rotate(0deg); }
            25% { transform: translateX(-30px) translateY(-15px) rotate(1deg); }
            50% { transform: translateX(30px) translateY(15px) rotate(-1deg); }
            75% { transform: translateX(-15px) translateY(30px) rotate(0.5deg); }
        }
        
        /* زجاج مورف نخبة العود الفاخر */
        .ai-glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-luxury);
            border-radius: 25px;
            overflow: hidden;
        }
        
        /* Beautiful Clock Component */
        .ai-clock-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .ai-clock {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient-elegant);
            border: 3px solid var(--oud-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 20px;
            box-shadow: 
                0 0 30px rgba(212, 175, 55, 0.4),
                inset 0 0 20px rgba(245, 245, 220, 0.2);
            animation: oudClockGlow 3s ease-in-out infinite;
        }
        
        @keyframes oudClockGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 30px rgba(212, 175, 55, 0.4),
                    inset 0 0 20px rgba(245, 245, 220, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 40px rgba(212, 175, 55, 0.6),
                    inset 0 0 30px rgba(245, 245, 220, 0.3);
            }
        }
        
        .ai-clock::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 35px;
            background: linear-gradient(to bottom, var(--oud-brown), var(--oud-brown-dark));
            border-radius: 2px;
            transform-origin: bottom center;
            animation: hourHand 43200s linear infinite;
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.5);
        }
        
        .ai-clock::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 45px;
            background: linear-gradient(to bottom, var(--oud-gold), var(--oud-gold-dark));
            border-radius: 1px;
            transform-origin: bottom center;
            animation: minuteHand 3600s linear infinite;
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }
        
        .ai-clock-center {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--oud-bronze);
            border: 2px solid var(--oud-gold);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 10px rgba(205, 127, 50, 0.5);
        }
        
        .ai-clock-numbers {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .ai-clock-number {
            position: absolute;
            color: var(--oud-brown);
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }
        
        .ai-clock-number:nth-child(1) { top: 5px; left: 50%; transform: translateX(-50%); }
        .ai-clock-number:nth-child(2) { top: 50%; right: 5px; transform: translateY(-50%); }
        .ai-clock-number:nth-child(3) { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .ai-clock-number:nth-child(4) { top: 50%; left: 5px; transform: translateY(-50%); }
        
        @keyframes hourHand {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }
        
        @keyframes minuteHand {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }
        
        .ai-time-display {
            text-align: center;
        }
        
        .ai-digital-time {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-luxury);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            position: relative;
        }
        
        .ai-digital-time::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
            animation: oudTimePulse 2s ease-in-out infinite;
        }
        
        @keyframes oudTimePulse {
            0%, 100% { opacity: 0.7; transform: translateX(-50%) scaleX(1); }
            50% { opacity: 1; transform: translateX(-50%) scaleX(1.1); }
        }
        
        .ai-date-display {
            color: var(--oud-gold-light);
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }
        
        /* جدول نخبة العود الفاخر */
        .ai-table-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: var(--shadow-luxury);
            border: 1px solid var(--glass-border);
        }
        
        .ai-table-header {
            background: var(--gradient-secondary);
            padding: 25px;
            border-bottom: 2px solid var(--oud-gold);
        }
        
        .ai-table-title {
            color: var(--oud-cream);
            font-size: 2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .ai-reports-icon {
            margin-left: 15px;
            font-size: 2.5rem;
            animation: oudReportsIconPulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.6));
        }
        
        @keyframes oudReportsIconPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.6));
            }
            50% { 
                transform: scale(1.1) rotate(5deg);
                filter: drop-shadow(0 0 20px rgba(255, 191, 0, 0.8));
            }
        }
        
        .ai-modern-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ai-modern-table th {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 69, 19, 0.3) 100%);
            color: var(--oud-cream);
            font-weight: 700;
            padding: 15px 8px;
            text-align: center;
            border-bottom: 2px solid var(--oud-gold);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .ai-modern-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
        }
        
        .ai-modern-table td {
            padding: 12px 6px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            color: var(--oud-cream);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .ai-modern-table tr:hover td {
            background: rgba(212, 175, 55, 0.08);
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }
        
        .ai-modern-table tr:nth-child(even) td {
            background: rgba(139, 69, 19, 0.05);
        }
        
        /* Schedule Table Styles */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.4) 0%, rgba(139, 69, 19, 0.4) 100%);
            color: var(--oud-cream);
            font-weight: 700;
            padding: 8px 4px;
            text-align: center;
            border: 1px solid var(--oud-gold);
            font-size: 0.7rem;
            white-space: nowrap;
        }
        
        .schedule-table td {
            padding: 6px 4px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
            font-size: 0.7rem;
            white-space: nowrap;
        }
        
        .employee-name {
            background: var(--gradient-primary);
            color: var(--oud-black);
            font-weight: 700;
            padding: 10px 8px !important;
            position: sticky;
            right: 0;
            z-index: 10;
        }
        
        .shift-cell {
            position: relative;
            min-width: 60px;
            padding: 10px 6px !important;
            text-align: center;
            border-radius: 8px;
            margin: 2px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .shift-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .shift-4-10 {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .shift-9-3 {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .shift-9-6 {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        .shift-11-8 {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .shift-1-10 {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .shift-off {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }
        
        .shift-annual {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
        }
        
        .shift-time {
            font-size: 0.8rem;
            font-weight: 800;
            display: block;
        }
        
        .shift-type {
            font-size: 0.6rem;
            opacity: 0.9;
            display: block;
            margin-top: 2px;
        }
        
        .date-header {
            min-width: 60px;
            font-size: 0.75rem;
            padding: 12px 8px !important;
            text-align: center;
            position: relative;
        }
        
        .date-number {
            font-size: 1rem;
            font-weight: 800;
            color: var(--oud-gold);
            display: block;
            margin-bottom: 4px;
        }
        
        .day-name {
            font-size: 0.7rem;
            opacity: 0.9;
            color: var(--oud-cream);
            font-weight: 600;
            display: block;
        }
        
        .weekend-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%) !important;
        }
        
        .weekend-header .date-number {
            color: #fca5a5;
        }
        
        /* نظام التنقل الجانبي */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100vh;
            background: var(--gradient-secondary);
            backdrop-filter: blur(25px);
            border-left: 2px solid var(--oud-gold);
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        /* Overlay for sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid var(--oud-gold);
            text-align: center;
        }
        
        .sidebar-logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--oud-gold);
            margin-bottom: 10px;
        }
        
        .sidebar-subtitle {
            color: var(--oud-cream);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--oud-cream);
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }
        
        .menu-item:hover,
        .menu-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-right-color: var(--oud-gold);
            color: var(--oud-gold);
        }
        
        .menu-icon {
            font-size: 1.2rem;
            margin-left: 15px;
            width: 25px;
            text-align: center;
        }
        
        /* أزرار التحكم العلوية */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .oud-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cairo', sans-serif;
            text-decoration: none;
        }
        
        .oud-btn-primary {
            background: var(--gradient-primary);
            color: var(--oud-black);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        
        .oud-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }
        
        .oud-btn-secondary {
            background: var(--gradient-secondary);
            color: var(--oud-cream);
            border: 1px solid var(--oud-gold);
        }
        
        .oud-btn-secondary:hover {
            background: var(--oud-gold);
            color: var(--oud-black);
        }
        
        .menu-toggle {
            background: var(--gradient-primary);
            color: var(--oud-black);
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            transform: scale(1.1);
        }
        
        /* نافذة منبثقة للإضافة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--gradient-secondary);
            border-radius: 25px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--oud-gold);
            box-shadow: var(--shadow-luxury);
            transform: scale(0.7) translateY(50px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--oud-gold);
        }
        
        .modal-title {
            color: var(--oud-gold);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--oud-cream);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: var(--oud-gold);
        }
        
        /* نموذج الإدخال */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--oud-cream);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--oud-bronze);
            border-radius: 10px;
            background: rgba(245, 245, 220, 0.1);
            color: var(--oud-cream);
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--oud-gold);
            background: rgba(245, 245, 220, 0.15);
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--oud-bronze);
            border-radius: 10px;
            background: rgba(245, 245, 220, 0.1);
            color: var(--oud-cream);
            font-family: 'Cairo', sans-serif;
        }
        
        /* إحصائيات سريعة */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-luxury);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--oud-gold);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--oud-cream);
            font-weight: 600;
        }
        
        /* فلاتر البحث */
        .filters-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Page Transition Animation */
        .page-transition {
            animation: pageSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes pageSlideIn {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Enhanced Menu Item Hover */
        .menu-item {
            position: relative;
            overflow: hidden;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
            transition: right 0.5s ease;
        }
        
        .menu-item:hover::before {
            right: 100%;
        }
        
        /* Notification Animations */
        @keyframes slideInRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes modalBounce {
            0% {
                transform: scale(0.3) translateY(100px);
                opacity: 0;
            }
            50% {
                transform: scale(1.05) translateY(-10px);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes modalSlideOut {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            100% {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
        }
        
        @keyframes titleUpdate {
            0% {
                transform: translateY(-10px);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-5px);
                opacity: 0.9;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive Design - تحسينات شاملة للجوال */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* للجوالات الحديثة */
            }
            
            .ai-clock {
                width: 80px;
                height: 80px;
                margin-left: 10px;
            }
            
            .ai-digital-time {
                font-size: 2rem;
            }
            
            .ai-table-title {
                font-size: 1.5rem;
            }
            
            .ai-reports-icon {
                font-size: 2rem;
                margin-left: 10px;
            }
            
            .schedule-table th,
            .schedule-table td {
                padding: 4px 2px;
                font-size: 0.6rem;
            }
            
            .top-controls {
                flex-direction: column;
                gap: 15px;
                padding: 0 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .login-card {
                padding: 30px 20px;
                margin: 10px;
                width: calc(100% - 20px);
            }
            
            .login-title {
                font-size: 1.5rem;
            }
            
            .login-logo {
                font-size: 3rem;
            }
            
            /* تحسينات خاصة بالجوال */
            body {
                padding: 10px;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* إظهار نص الخروج في الجوال */
            .top-controls button[title="تسجيل الخروج"] span:last-child {
                display: inline !important;
                margin-right: 5px;
            }
            
            .menu-item {
                padding: 18px 25px;
                font-size: 1.1rem;
                min-height: 50px;
            }
            
            .menu-icon {
                font-size: 1.4rem;
                margin-left: 15px;
            }
            
            /* تحسين الأزرار للمس */
            .oud-btn {
                min-height: 48px;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            /* تحسين الجداول للجوال */
            .table-scroll {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* تحسين النوافذ المنبثقة */
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* تحسين الإدخال للجوال */
            .form-input,
            .form-select,
            .login-input {
                font-size: 16px; /* منع التكبير في iOS */
                min-height: 48px;
            }
        }
        
        /* تحسينات إضافية للجوالات الصغيرة */
        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .ai-clock-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .ai-clock {
                width: 60px;
                height: 60px;
                margin: 0;
            }
            
            .ai-digital-time {
                font-size: 1.8rem;
            }
            
            .login-card {
                padding: 20px 15px;
            }
            
            .sidebar-header {
                padding: 20px 15px;
            }
            
            .menu-item {
                padding: 15px 20px;
            }
        }
        
        /* تحسينات Safari و WebKit */
        @supports (-webkit-touch-callout: none) {
            .sidebar {
                -webkit-overflow-scrolling: touch;
            }
            
            .login-input,
            .form-input {
                -webkit-appearance: none;
                border-radius: 18px;
            }
            
            body {
                -webkit-user-select: none;
                user-select: none;
            }
            
            input, textarea, button {
                -webkit-user-select: text;
                user-select: text;
            }
        }
        
        /* تحسينات للوضع الأفقي */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar-header {
                padding: 15px 20px;
            }
            
            .sidebar-logo {
                font-size: 1.5rem;
            }
            
            .menu-item {
                padding: 12px 25px;
            }
            
            .ai-clock-container {
                margin-bottom: 15px;
            }
        }
        
        /* Table scroll for mobile */
        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-scroll::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--oud-gold);
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--oud-gold-dark);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">نخبة العود</h1>
            <p class="login-subtitle">نظام إدارة الحضور والانصراف</p>
            
            <form class="login-form" id="loginForm">
                <div class="login-input-group">
                    <span class="login-input-icon">👤</span>
                    <input type="text" class="login-input" id="username" placeholder="اسم المستخدم" required>
                </div>
                
                <div class="login-input-group">
                    <span class="login-input-icon">🔒</span>
                    <input type="password" class="login-input" id="password" placeholder="كلمة المرور" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <span style="margin-left: 8px;">🚀</span>
                    تسجيل الدخول
                </button>
                
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
            </form>
            
            <!-- بيانات تسجيل الدخول المبسطة -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 10px; border: 1px solid var(--oud-gold);">
                <div style="color: var(--oud-gold); font-weight: 600; margin-bottom: 10px; text-align: center;">
                    🔑 بيانات تسجيل الدخول
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                    <div style="color: var(--oud-cream); text-align: center; padding: 8px; background: rgba(212, 175, 55, 0.05); border-radius: 5px;">
                        <div style="font-weight: bold; color: var(--oud-gold);">👨‍💼 المدير</div>
                        <div>admin / 123</div>
                    </div>
                    
                    <div style="color: var(--oud-cream); text-align: center; padding: 8px; background: rgba(212, 175, 55, 0.05); border-radius: 5px;">
                        <div style="font-weight: bold; color: var(--oud-gold);">👤 الموظفين</div>
                        <div>الاسم / 123</div>
                    </div>
                </div>
                
                <div style="margin-top: 10px; font-size: 0.8rem; color: var(--oud-cream); opacity: 0.8; text-align: center;">
                    أمثلة: badr, saad, hussein, ahmed, yazeed, noura
                </div>
                
                <!-- زر اختبار سريع -->
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" onclick="quickLogin('admin')" style="
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        border: none;
                        padding: 8px 15px;
                        border-radius: 10px;
                        font-family: 'Cairo', sans-serif;
                        font-size: 0.9rem;
                        font-weight: 600;
                        cursor: pointer;
                        margin: 0 5px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        🚀 دخول سريع - مدير
                    </button>
                    <button type="button" onclick="quickLogin('badr')" style="
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        color: white;
                        border: none;
                        padding: 8px 15px;
                        border-radius: 10px;
                        font-family: 'Cairo', sans-serif;
                        font-size: 0.9rem;
                        font-weight: 600;
                        cursor: pointer;
                        margin: 0 5px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        👤 دخول سريع - موظف
                    </button>
                </div>
                
                <!-- تعليمات مشاركة الرابط -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border: 1px solid #10b981;">
                    <div style="color: #10b981; font-weight: 600; margin-bottom: 10px; text-align: center; font-size: 0.9rem;">
                        📱 كيفية مشاركة النظام مع الموظفين
                    </div>
                    <div style="color: var(--oud-cream); font-size: 0.8rem; line-height: 1.5; text-align: center;">
                        <div style="margin-bottom: 8px;">
                            <strong>1.</strong> احفظ هذه الصفحة كملف HTML على جهازك
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>2.</strong> ارفع الملف على خادم ويب أو استخدم GitHub Pages
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>3.</strong> شارك الرابط مع الموظفين
                        </div>
                        <div style="color: #10b981; font-weight: bold; margin-top: 10px;">
                            ✅ سيعمل النظام تلقائياً عبر جميع الأجهزة!
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">🏛️ نخبة العود</div>
            <div class="sidebar-subtitle">نظام إدارة الحضور والانصراف</div>
        </div>
        <nav class="sidebar-menu">
            <a href="#" class="menu-item active" data-section="dashboard" onclick="navigateToSection('dashboard', this)">
                <span class="menu-icon">📊</span>
                <span>لوحة التحكم</span>
            </a>
            <a href="#" class="menu-item" data-section="schedule" onclick="navigateToSection('schedule', this)">
                <span class="menu-icon">📅</span>
                <span>جدولة الموظفين</span>
            </a>
            <a href="#" class="menu-item" data-section="employees" onclick="navigateToSection('employees', this)">
                <span class="menu-icon">👥</span>
                <span>إدارة الموظفين</span>
            </a>
            <a href="#" class="menu-item" data-section="attendance" onclick="navigateToSection('attendance', this)">
                <span class="menu-icon">⏰</span>
                <span>سجل الحضور</span>
            </a>
            <a href="#" class="menu-item" data-section="reports" onclick="navigateToSection('reports', this)">
                <span class="menu-icon">📈</span>
                <span>التقارير</span>
            </a>
            <a href="#" class="menu-item" data-section="settings" onclick="navigateToSection('settings', this)">
                <span class="menu-icon">⚙️</span>
                <span>الإعدادات</span>
            </a>
            
            <!-- زر تسجيل الخروج الفعال -->
            <div style="margin-top: auto; padding: 20px 0; border-top: 2px solid var(--oud-gold);">
                <button onclick="logout()" class="menu-item" style="
                    width: 100%;
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                    color: white;
                    border: none;
                    padding: 15px 25px;
                    border-radius: 12px;
                    font-family: 'Cairo', sans-serif;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
                    margin: 0 20px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 38, 38, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220, 38, 38, 0.3)'">
                    <span style="font-size: 1.2rem;">🚪</span>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent" style="display: none; visibility: hidden; opacity: 0; transition: all 0.3s ease;">
        <!-- Top Controls -->
        <div class="top-controls">
            <div class="control-group">
                <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">☰</button>
                <h2 style="color: var(--oud-gold); margin: 0;" id="pageTitle">نظام إدارة الحضور والانصراف</h2>
                
                <!-- مؤشر حالة الاتصال -->
                <div id="connectionStatus" style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    background: rgba(16, 185, 129, 0.1);
                    padding: 8px 12px;
                    border-radius: 20px;
                    border: 1px solid #10b981;
                    margin-right: 10px;
                ">
                    <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                    <span style="color: #10b981; font-size: 0.9rem; font-weight: 600;">متصل</span>
                </div>
                
                <!-- زر خروج سريع في الشريط العلوي -->
                <button onclick="logout()" class="oud-btn" style="
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                    color: white;
                    padding: 8px 12px;
                    font-size: 0.9rem;
                    margin-right: 10px;
                    min-height: 40px;
                    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
                " title="تسجيل الخروج">
                    <span style="font-size: 1rem;">🚪</span>
                    <span style="display: none;">خروج</span>
                </button>
            </div>
            <div class="control-group">
                <button class="oud-btn oud-btn-primary" id="addEmployeeBtn" onclick="openModal('addEmployeeModal')">
                    <span>➕</span>
                    إضافة موظف
                </button>
                <button class="oud-btn oud-btn-secondary" id="exportBtn" onclick="exportData()">
                    <span>📤</span>
                    تصدير البيانات
                </button>
            </div>
        </div>

        <!-- Beautiful Clock Display -->
        <div class="ai-clock-container">
            <div class="ai-clock">
                <div class="ai-clock-numbers">
                    <div class="ai-clock-number">12</div>
                    <div class="ai-clock-number">3</div>
                    <div class="ai-clock-number">6</div>
                    <div class="ai-clock-number">9</div>
                </div>
                <div class="ai-clock-center"></div>
            </div>
            <div class="ai-time-display">
                <div class="ai-digital-time" id="currentTime"></div>
                <div class="ai-date-display" id="currentDate"></div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <span class="stat-icon">👥</span>
                <div class="stat-number" id="totalEmployees">6</div>
                <div class="stat-label">إجمالي الموظفين</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">✅</span>
                <div class="stat-number" id="presentToday">0</div>
                <div class="stat-label">حاضر اليوم</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">❌</span>
                <div class="stat-number" id="absentToday">0</div>
                <div class="stat-label">غائب اليوم</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">📊</span>
                <div class="stat-number" id="attendanceRate">0%</div>
                <div class="stat-label">معدل الحضور</div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">📊</span>
                        لوحة التحكم الرئيسية
                    </h1>
                </div>
                
                <div style="padding: 30px;">
                    <div style="text-align: center; color: var(--oud-cream);">
                        <div style="font-size: 4rem; margin-bottom: 20px;">🏛️</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px;">مرحباً بك في نظام نخبة العود</h3>
                        <p style="font-size: 1.1rem; opacity: 0.8; margin-bottom: 30px;">نظام متكامل لإدارة الحضور والانصراف وجدولة الموظفين</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                            <div class="stat-card">
                                <span class="stat-icon">📅</span>
                                <div class="stat-number">40</div>
                                <div class="stat-label">يوم عمل مجدول</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-icon">⏰</span>
                                <div class="stat-number">8.5</div>
                                <div class="stat-label">متوسط ساعات العمل</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-icon">📈</span>
                                <div class="stat-number">95%</div>
                                <div class="stat-label">معدل الحضور</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Schedule Section -->
        <div class="content-section" id="schedule-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">📅</span>
                        جدولة الموظفين - أغسطس 2025
                    </h1>
                </div>
                
                <div class="table-scroll" style="padding: 20px;">
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="employee-name">الموظف</th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">1</span>
                                    <span class="day-name">الجمعة</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">2</span>
                                    <span class="day-name">السبت</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">3</span>
                                    <span class="day-name">الأحد</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">4</span>
                                    <span class="day-name">الاثنين</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">5</span>
                                    <span class="day-name">الثلاثاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">6</span>
                                    <span class="day-name">الأربعاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">7</span>
                                    <span class="day-name">الخميس</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">8</span>
                                    <span class="day-name">الجمعة</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">9</span>
                                    <span class="day-name">السبت</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">10</span>
                                    <span class="day-name">الأحد</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">11</span>
                                    <span class="day-name">الاثنين</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">12</span>
                                    <span class="day-name">الثلاثاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">13</span>
                                    <span class="day-name">الأربعاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">14</span>
                                    <span class="day-name">الخميس</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">15</span>
                                    <span class="day-name">الجمعة</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">16</span>
                                    <span class="day-name">السبت</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">17</span>
                                    <span class="day-name">الأحد</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">18</span>
                                    <span class="day-name">الاثنين</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">19</span>
                                    <span class="day-name">الثلاثاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">20</span>
                                    <span class="day-name">الأربعاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">21</span>
                                    <span class="day-name">الخميس</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">22</span>
                                    <span class="day-name">الجمعة</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">23</span>
                                    <span class="day-name">السبت</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">24</span>
                                    <span class="day-name">الأحد</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">25</span>
                                    <span class="day-name">الاثنين</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">26</span>
                                    <span class="day-name">الثلاثاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">27</span>
                                    <span class="day-name">الأربعاء</span>
                                </th>
                                <th class="date-header">
                                    <span class="date-number">28</span>
                                    <span class="day-name">الخميس</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">29</span>
                                    <span class="day-name">الجمعة</span>
                                </th>
                                <th class="date-header weekend-header">
                                    <span class="date-number">30</span>
                                    <span class="day-name">السبت</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Schedule data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Employees Management Section -->
        <div class="content-section" id="employees-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">👥</span>
                        إدارة الموظفين - الحالة الفعلية
                    </h1>
                </div>
                
                <div style="padding: 30px;">
                    <!-- إحصائيات دقيقة حسب الجدول الفعلي -->
                    <div class="stats-container">
                        <div class="stat-card" onclick="showEmployeesByStatus('present')" style="cursor: pointer;">
                            <span class="stat-icon">✅</span>
                            <div class="stat-number" id="actualPresentCount">0</div>
                            <div class="stat-label">حاضر ومباشر</div>
                        </div>
                        <div class="stat-card" onclick="showEmployeesByStatus('weeklyLeave')" style="cursor: pointer;">
                            <span class="stat-icon">💤</span>
                            <div class="stat-number" id="weeklyLeaveCount">0</div>
                            <div class="stat-label">إجازة أسبوعية</div>
                        </div>
                        <div class="stat-card" onclick="showEmployeesByStatus('annualLeave')" style="cursor: pointer;">
                            <span class="stat-icon">🏖️</span>
                            <div class="stat-number" id="annualLeaveCount">0</div>
                            <div class="stat-label">إجازة سنوية</div>
                        </div>
                        <div class="stat-card" onclick="showEmployeesByStatus('loggedIn')" style="cursor: pointer;">
                            <span class="stat-icon">🔐</span>
                            <div class="stat-number" id="loggedInCount">0</div>
                            <div class="stat-label">مسجل دخول</div>
                        </div>
                    </div>
                    
                    <!-- جدول الموظفين الدقيق -->
                    <div class="ai-table-container" style="margin-top: 30px;">
                        <div class="ai-table-header">
                            <h3 style="color: var(--oud-gold); margin: 0; font-size: 1.3rem;">
                                <span style="margin-left: 10px;">📋</span>
                                حالة الموظفين الفعلية اليوم
                            </h3>
                        </div>
                        
                        <div class="table-scroll" style="padding: 20px;">
                            <table class="ai-modern-table">
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الكود</th>
                                        <th>القسم</th>
                                        <th>الوردية المجدولة</th>
                                        <th>الحالة الفعلية</th>
                                        <th>وقت الحضور</th>
                                        <th>حالة النظام</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="preciseEmployeeTableBody">
                                    <!-- سيتم ملء البيانات بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ملاحظة للمدير -->
                    <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; margin-top: 20px; border: 1px solid var(--oud-gold);">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem; margin-left: 10px;">ℹ️</span>
                            <h4 style="color: var(--oud-gold); margin: 0;">ملاحظة للمدير</h4>
                        </div>
                        <p style="color: var(--oud-cream); margin: 0; line-height: 1.6;">
                            هذا القسم يعرض الحالة الفعلية للموظفين بناءً على الجدولة المحددة وحالة تسجيل الدخول في النظام.
                            يتم تحديث البيانات تلقائياً كل دقيقة لضمان الدقة.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Records Section -->
        <div class="content-section" id="attendance-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">⏰</span>
                        سجل الحضور والانصراف
                    </h1>
                </div>
                
                <div style="padding: 30px;">
                    <!-- إحصائيات الحضور المباشرة -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <span class="stat-icon">👥</span>
                            <div class="stat-number" id="totalEmployeesCount">6</div>
                            <div class="stat-label">إجمالي الموظفين</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">✅</span>
                            <div class="stat-number" id="presentCount">0</div>
                            <div class="stat-label">حاضر اليوم</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">⚠️</span>
                            <div class="stat-number" id="lateCount">0</div>
                            <div class="stat-label">متأخر</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">💼</span>
                            <div class="stat-number" id="workingCount">0</div>
                            <div class="stat-label">يعمل حالياً</div>
                        </div>
                    </div>
                    
                    <!-- حالة حضور المستخدم الحالي -->
                    <div class="ai-table-container" style="margin-bottom: 30px;">
                        <div id="userAttendanceStatus">
                            <div style="padding: 20px; text-align: center;">
                                <div style="color: var(--oud-cream); opacity: 0.7;">يرجى تسجيل الدخول لعرض حالة الحضور</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- أزرار الإجراءات -->
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="oud-btn oud-btn-primary" id="checkInBtn" onclick="manualCheckIn()">
                                <span>📝</span>
                                تسجيل حضور
                            </button>
                            <button class="oud-btn oud-btn-secondary" id="checkOutBtn" onclick="openCheckOutModal()" style="display: none;">
                                <span>🏠</span>
                                تسجيل انصراف
                            </button>
                        </div>
                    </div>
                    
                    <!-- جدول الحضور اليومي -->
                    <div class="ai-table-container">
                        <div class="ai-table-header">
                            <h3 style="color: var(--oud-gold); margin: 0; font-size: 1.3rem;">
                                <span style="margin-left: 10px;">📋</span>
                                سجل الحضور اليوم
                            </h3>
                        </div>
                        
                        <div class="table-scroll" style="padding: 20px;">
                            <table class="ai-modern-table">
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>وقت الحضور</th>
                                        <th>وقت الانصراف</th>
                                        <th>ساعات العمل</th>
                                        <th>الحالة</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAttendanceTableBody">
                                    <!-- سيتم ملء البيانات بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="content-section" id="reports-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">⏰</span>
                        تقارير التأخير
                    </h1>
                </div>
                
                <div style="padding: 30px;">
                    <!-- إحصائيات التأخير فقط -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <span class="stat-icon">⏰</span>
                            <div class="stat-number" id="totalLateMinutes">0</div>
                            <div class="stat-label">إجمالي دقائق التأخير</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">👥</span>
                            <div class="stat-number" id="employeesWithLate">0</div>
                            <div class="stat-label">موظفين متأخرين</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">📊</span>
                            <div class="stat-number" id="avgLatePerEmployee">0</div>
                            <div class="stat-label">متوسط التأخير/موظف</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">📈</span>
                            <div class="stat-number" id="lateIncidentsCount">0</div>
                            <div class="stat-label">حالات التأخير</div>
                        </div>
                    </div>
                    
                    <!-- جدول تفاصيل التأخير -->
                    <div class="ai-table-container" style="margin-top: 30px;">
                        <div class="ai-table-header">
                            <h3 style="color: var(--oud-gold); margin: 0; font-size: 1.3rem;">
                                <span style="margin-left: 10px;">📋</span>
                                تفاصيل التأخير للموظفين
                            </h3>
                        </div>
                        
                        <div class="table-scroll" style="padding: 20px;">
                            <table class="ai-modern-table">
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الكود</th>
                                        <th>إجمالي دقائق التأخير</th>
                                        <th>عدد مرات التأخير</th>
                                        <th>آخر تأخير</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="lateReportTableBody">
                                    <!-- سيتم ملء البيانات بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="oud-btn oud-btn-secondary" onclick="updateLateReports()">
                                <span>🔄</span>
                                تحديث التقارير
                            </button>
                            <button class="oud-btn oud-btn-primary" onclick="exportLateReport()">
                                <span>📊</span>
                                تصدير تقرير التأخير
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="content-section" id="settings-section">
            <div class="ai-table-container">
                <div class="ai-table-header">
                    <h1 class="ai-table-title">
                        <span class="ai-reports-icon">⚙️</span>
                        إعدادات النظام
                    </h1>
                </div>
                
                <div style="padding: 30px;">
                    <div class="stats-container">
                        <div class="stat-card">
                            <span class="stat-icon">🏢</span>
                            <div class="stat-number">نخبة العود</div>
                            <div class="stat-label">اسم الشركة</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">🕘</span>
                            <div class="stat-number">09:00</div>
                            <div class="stat-label">وقت بداية العمل</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">🕔</span>
                            <div class="stat-number">18:00</div>
                            <div class="stat-label">وقت نهاية العمل</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">⏰</span>
                            <div class="stat-number">15 دقيقة</div>
                            <div class="stat-label">هامش التأخير</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 50px; color: var(--oud-cream);">
                        <div style="font-size: 4rem; margin-bottom: 20px;">⚙️</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px;">إعدادات النظام</h3>
                        <p style="font-size: 1.1rem; opacity: 0.8;">تخصيص إعدادات النظام وأوقات العمل والإشعارات</p>
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                            <button class="oud-btn oud-btn-primary">
                                <span>🏢</span>
                                إعدادات الشركة
                            </button>
                            <button class="oud-btn oud-btn-secondary">
                                <span>⏰</span>
                                أوقات العمل
                            </button>
                            <button class="oud-btn oud-btn-primary">
                                <span>🔔</span>
                                الإشعارات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة موظف جديد</h3>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">&times;</button>
            </div>
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label class="form-label">اسم الموظف</label>
                    <input type="text" class="form-input" id="employeeName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الموظف</label>
                    <input type="text" class="form-input" id="employeeId" required>
                </div>
                <div class="form-group">
                    <label class="form-label">القسم</label>
                    <select class="form-select" id="employeeDepartment" required>
                        <option value="">اختر القسم</option>
                        <option value="خدمة عملاء نخبة العود">خدمة عملاء نخبة العود</option>
                        <option value="المبيعات">المبيعات</option>
                        <option value="الإدارة">الإدارة</option>
                        <option value="التسويق">التسويق</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المنصب</label>
                    <input type="text" class="form-input" id="employeePosition">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="tel" class="form-input" id="employeePhone">
                </div>
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" class="form-input" id="employeeEmail">
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="oud-btn oud-btn-secondary" onclick="closeModal('addEmployeeModal')">إلغاء</button>
                    <button type="submit" class="oud-btn oud-btn-primary">حفظ الموظف</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee Details Modal -->
    <div class="modal" id="employeeDetailsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل الموظف</h3>
                <button class="close-btn" onclick="closeModal('employeeDetailsModal')">&times;</button>
            </div>
            <div id="employeeDetailsContent">
                <!-- Employee details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Attendance Confirmation Modal -->
    <div class="modal" id="attendanceModal">
        <div class="modal-content" style="max-width: 600px;">
            <div id="attendanceModalContent">
                <!-- Attendance confirmation content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Check Out Confirmation Modal -->
    <div class="modal" id="checkOutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تأكيد تسجيل الانصراف</h3>
                <button class="close-btn" onclick="closeModal('checkOutModal')">&times;</button>
            </div>
            <div style="padding: 30px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 20px;">🏠</div>
                <h3 style="color: var(--oud-gold); margin-bottom: 15px;">هل تريد تسجيل الانصراف؟</h3>
                <p style="color: var(--oud-cream); margin-bottom: 30px; opacity: 0.8;">
                    سيتم حساب ساعات العمل تلقائياً وإنهاء يوم العمل
                </p>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="oud-btn oud-btn-secondary" onclick="closeModal('checkOutModal')">
                        <span>❌</span> إلغاء
                    </button>
                    <button class="oud-btn oud-btn-primary" onclick="confirmCheckOut()">
                        <span>✅</span> تأكيد الانصراف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Status Modal -->
    <div class="modal" id="employeeStatusModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="statusModalTitle">قائمة الموظفين</h3>
                <button class="close-btn" onclick="closeModal('employeeStatusModal')">&times;</button>
            </div>
            <div id="employeeStatusContent">
                <!-- Employee status content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // نظام تتبع الاتصال المتقدم والدقيق مع إشعارات فورية للمدير
        const connectionTracker = {
            // مفتاح التخزين المشترك لجميع الأجهزة
            STORAGE_KEY: 'oudGlobalConnectionData',
            BROADCAST_KEY: 'oudConnectionBroadcast',
            HEARTBEAT_KEY: 'oudHeartbeat',
            
            // تحديث حالة المستخدم مع إشعار فوري للمدير وحفظ عالمي
            updateUserStatus(username, isOnline) {
                if (users[username]) {
                    const wasOnline = users[username].isOnline;
                    users[username].isOnline = isOnline;
                    users[username].connectionStatus = isOnline ? 'متصل' : 'غير متصل';
                    users[username].lastActivity = new Date().toISOString();
                    users[username].deviceInfo = this.getDeviceInfo();
                    users[username].sessionId = this.generateSessionId();
                    
                    console.log(`🔄 تحديث حالة ${users[username].name}: ${isOnline ? '🟢 متصل' : '🔴 غير متصل'}`);
                    console.log(`📱 الجهاز: ${users[username].deviceInfo.type} - ${users[username].deviceInfo.browser}`);
                    console.log(`🆔 معرف الجلسة: ${users[username].sessionId}`);
                    
                    // حفظ عالمي فوري لجميع الأجهزة
                    this.saveGlobalConnectionData();
                    
                    // بث فوري للتغيير لجميع الأجهزة
                    this.broadcastToAllDevices(username, isOnline);
                    
                    // إشعار فوري للمدير عند تغيير حالة الاتصال
                    if (wasOnline !== isOnline) {
                        this.notifyAdminOfStatusChange(username, isOnline);
                        this.broadcastStatusChange(username, isOnline);
                    }
                    
                    // تحديث فوري لجدول الموظفين إذا كان المدير متصل
                    if (currentUser && currentUser.role === 'مدير') {
                        setTimeout(() => {
                            preciseEmployeeManagement.updatePreciseEmployeeTable();
                        }, 100);
                    }
                }
            },

            // الحصول على معلومات الجهاز
            getDeviceInfo() {
                const userAgent = navigator.userAgent;
                let deviceType = 'Desktop';
                let browser = 'Unknown';
                let os = 'Unknown';
                
                // تحديد نوع الجهاز
                if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
                    deviceType = /iPad/.test(userAgent) ? 'Tablet' : 'Mobile';
                }
                
                // تحديد المتصفح
                if (userAgent.includes('Chrome')) browser = 'Chrome';
                else if (userAgent.includes('Firefox')) browser = 'Firefox';
                else if (userAgent.includes('Safari')) browser = 'Safari';
                else if (userAgent.includes('Edge')) browser = 'Edge';
                
                // تحديد نظام التشغيل
                if (userAgent.includes('Windows')) os = 'Windows';
                else if (userAgent.includes('Mac')) os = 'macOS';
                else if (userAgent.includes('Linux')) os = 'Linux';
                else if (userAgent.includes('Android')) os = 'Android';
                else if (userAgent.includes('iOS')) os = 'iOS';
                
                return {
                    type: deviceType,
                    browser: browser,
                    os: os,
                    userAgent: userAgent,
                    timestamp: new Date().toISOString()
                };
            },

            // توليد معرف جلسة فريد
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // حفظ بيانات الاتصال العالمية (مشتركة بين جميع الأجهزة)
            saveGlobalConnectionData() {
                try {
                    const globalData = {
                        lastUpdate: new Date().toISOString(),
                        connections: {}
                    };
                    
                    Object.keys(users).forEach(username => {
                        const user = users[username];
                        globalData.connections[username] = {
                            isOnline: user.isOnline || false,
                            lastLogin: user.lastLogin,
                            lastActivity: user.lastActivity,
                            connectionStatus: user.connectionStatus || 'غير متصل',
                            deviceInfo: user.deviceInfo,
                            sessionId: user.sessionId,
                            name: user.name,
                            role: user.role,
                            code: user.code
                        };
                    });
                    
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(globalData));
                    
                    // محاولة حفظ في IndexedDB للمزامنة المتقدمة
                    this.saveToIndexedDB(globalData);
                    
                    console.log('🌐 تم حفظ بيانات الاتصال العالمية');
                    
                } catch (error) {
                    console.error('❌ خطأ في حفظ البيانات العالمية:', error);
                }
            },

            // تحميل بيانات الاتصال العالمية
            loadGlobalConnectionData() {
                try {
                    const globalData = localStorage.getItem(this.STORAGE_KEY);
                    if (globalData) {
                        const data = JSON.parse(globalData);
                        
                        Object.keys(data.connections).forEach(username => {
                            if (users[username]) {
                                const connectionData = data.connections[username];
                                users[username].isOnline = connectionData.isOnline || false;
                                users[username].lastLogin = connectionData.lastLogin;
                                users[username].lastActivity = connectionData.lastActivity;
                                users[username].connectionStatus = connectionData.connectionStatus || 'غير متصل';
                                users[username].deviceInfo = connectionData.deviceInfo;
                                users[username].sessionId = connectionData.sessionId;
                            }
                        });
                        
                        console.log('🌐 تم تحميل بيانات الاتصال العالمية');
                        console.log(`📊 آخر تحديث: ${data.lastUpdate}`);
                        
                        // عرض المتصلين حالياً
                        const onlineUsers = Object.keys(data.connections).filter(u => data.connections[u].isOnline);
                        console.log(`👥 المتصلين حالياً: ${onlineUsers.length}`);
                        onlineUsers.forEach(username => {
                            const conn = data.connections[username];
                            console.log(`   🟢 ${conn.name} - ${conn.deviceInfo?.type || 'Unknown'} (${conn.deviceInfo?.browser || 'Unknown'})`);
                        });
                    }
                } catch (error) {
                    console.error('❌ خطأ في تحميل البيانات العالمية:', error);
                }
            },

            // بث فوري لجميع الأجهزة والتبويبات
            broadcastToAllDevices(username, isOnline) {
                const broadcastData = {
                    type: 'connection_update',
                    username: username,
                    isOnline: isOnline,
                    timestamp: new Date().toISOString(),
                    user: users[username],
                    deviceInfo: users[username].deviceInfo,
                    sessionId: users[username].sessionId
                };
                
                // حفظ في localStorage للمزامنة بين التبويبات
                localStorage.setItem(this.BROADCAST_KEY, JSON.stringify(broadcastData));
                
                // إرسال حدث مخصص للتبويبات في نفس الجهاز
                const event = new CustomEvent('oudConnectionUpdate', {
                    detail: broadcastData
                });
                window.dispatchEvent(event);
                
                console.log(`📡 بث فوري لجميع الأجهزة: ${users[username].name} ${isOnline ? 'متصل' : 'غير متصل'}`);
                
                // محاولة إرسال عبر BroadcastChannel للمتصفحات الحديثة
                try {
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('oudSystem');
                        channel.postMessage(broadcastData);
                        console.log('📻 تم الإرسال عبر BroadcastChannel');
                    }
                } catch (error) {
                    console.log('⚠️ BroadcastChannel غير مدعوم');
                }
            },

            // بث تغيير الحالة لجميع الأجهزة المتصلة
            broadcastStatusChange(username, isOnline) {
                // إرسال حدث مخصص للتبويبات الأخرى
                const event = new CustomEvent('oudStatusChange', {
                    detail: {
                        username: username,
                        isOnline: isOnline,
                        timestamp: new Date().toISOString(),
                        user: users[username]
                    }
                });
                
                window.dispatchEvent(event);
                
                // محاكاة إرسال للخادم (في التطبيق الحقيقي سيكون WebSocket)
                this.simulateServerBroadcast(username, isOnline);
                
                console.log(`📡 تم بث تغيير حالة ${users[username].name} لجميع الأجهزة`);
            },

            // محاكاة إرسال للخادم
            simulateServerBroadcast(username, isOnline) {
                // في التطبيق الحقيقي، سيتم إرسال هذا للخادم عبر WebSocket أو API
                const broadcastData = {
                    type: 'status_change',
                    username: username,
                    isOnline: isOnline,
                    timestamp: new Date().toISOString(),
                    deviceInfo: users[username].deviceInfo,
                    sessionId: users[username].sessionId
                };
                
                console.log('🌐 محاكاة إرسال للخادم:', broadcastData);
                
                // محاكاة استقبال من الخادم بعد تأخير قصير
                setTimeout(() => {
                    this.handleServerBroadcast(broadcastData);
                }, 500);
            },

            // معالجة البث من الخادم
            handleServerBroadcast(data) {
                console.log('📨 استقبال بث من الخادم:', data);
                
                // تحديث البيانات المحلية
                if (users[data.username]) {
                    users[data.username].isOnline = data.isOnline;
                    users[data.username].lastActivity = data.timestamp;
                    users[data.username].deviceInfo = data.deviceInfo;
                }
                
                // إشعار المدير إذا كان متصل
                if (currentUser && currentUser.role === 'مدير') {
                    this.showRealTimeNotification(data);
                }
                
                // تحديث الواجهة
                this.broadcastUpdate();
            },

            // عرض إشعار فوري للمدير
            showRealTimeNotification(data) {
                const user = users[data.username];
                if (!user || user.role === 'مدير') return;
                
                const statusText = data.isOnline ? 'دخل للنظام' : 'خرج من النظام';
                const statusIcon = data.isOnline ? '🟢' : '🔴';
                const deviceInfo = data.deviceInfo ? `${data.deviceInfo.type} - ${data.deviceInfo.browser}` : 'جهاز غير معروف';
                
                // إنشاء إشعار متقدم
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--oud-gold), var(--oud-amber));
                    color: var(--oud-black);
                    padding: 20px 25px;
                    border-radius: 15px;
                    font-family: 'Cairo', sans-serif;
                    font-weight: 700;
                    z-index: 15000;
                    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
                    animation: slideInRight 0.5s ease-out;
                    border: 2px solid var(--oud-bronze);
                    min-width: 350px;
                    cursor: pointer;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2.5rem;">${statusIcon}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 5px;">
                                ${user.name}
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 3px;">
                                ${statusText} - ${new Date().toLocaleTimeString('ar-SA', { hour12: false })}
                            </div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">
                                📱 ${deviceInfo}
                            </div>
                        </div>
                        <div style="font-size: 1.5rem; opacity: 0.6;">
                            ${data.isOnline ? '🔥' : '💤'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // إزالة الإشعار بعد 6 ثوان أو عند النقر
                const removeNotification = () => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                };
                
                notification.addEventListener('click', removeNotification);
                setTimeout(removeNotification, 6000);
                
                // صوت تنبيه (محاكاة)
                console.log(`🔔 إشعار فوري للمدير: ${user.name} ${statusText} من ${deviceInfo}`);
            },

            // إشعار المدير فوراً بتغيير حالة الموظف
            notifyAdminOfStatusChange(username, isOnline) {
                // التحقق من وجود مدير متصل
                if (currentUser && currentUser.role === 'مدير') {
                    const user = users[username];
                    if (user && user.role !== 'مدير') {
                        const statusText = isOnline ? 'دخل للنظام' : 'خرج من النظام';
                        const statusIcon = isOnline ? '🟢' : '🔴';
                        const currentTime = new Date().toLocaleTimeString('ar-SA', { hour12: false });
                        
                        // إشعار صوتي ومرئي فوري
                        this.showAdminNotification(user.name, statusText, statusIcon, currentTime);
                        
                        // تسجيل في الكونسول للمراقبة
                        console.log(`👨‍💼 إشعار المدير: ${user.name} ${statusText} في ${currentTime}`);
                        
                        // إذا كان موظف دخل للنظام، عرض تفاصيل إضافية
                        if (isOnline) {
                            setTimeout(() => {
                                this.showEmployeeLoginDetails(username);
                            }, 2000);
                        }
                    }
                }
            },

            // عرض إشعار فوري للمدير
            showAdminNotification(employeeName, statusText, statusIcon, time) {
                // إنشاء إشعار منبثق فوري
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--oud-gold), var(--oud-amber));
                    color: var(--oud-black);
                    padding: 20px 25px;
                    border-radius: 15px;
                    font-family: 'Cairo', sans-serif;
                    font-weight: 700;
                    z-index: 15000;
                    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
                    animation: slideInRight 0.5s ease-out;
                    border: 2px solid var(--oud-bronze);
                    min-width: 300px;
                    cursor: pointer;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2rem;">${statusIcon}</div>
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 800; margin-bottom: 5px;">
                                ${employeeName}
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">
                                ${statusText} - ${time}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // إزالة الإشعار بعد 5 ثوان أو عند النقر
                const removeNotification = () => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                };
                
                notification.addEventListener('click', removeNotification);
                setTimeout(removeNotification, 5000);
                
                // صوت تنبيه (محاكاة)
                console.log(`🔔 تنبيه صوتي: ${employeeName} ${statusText}`);
            },

            // عرض تفاصيل دخول الموظف للمدير
            showEmployeeLoginDetails(username) {
                if (!currentUser || currentUser.role !== 'مدير') return;
                
                const user = users[username];
                const employee = employeesData.find(emp => {
                    const empUsername = Object.keys(users).find(u => users[u].name === emp.name);
                    return empUsername === username;
                });
                
                if (!user || !employee) return;
                
                // الحصول على حالة الموظف الدقيقة
                const status = preciseEmployeeManagement.getPreciseEmployeeStatus(employee);
                const connectionDuration = this.getConnectionDuration(username);
                
                // إنشاء نافذة تفاصيل سريعة
                const detailsModal = document.createElement('div');
                detailsModal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    right: 20px;
                    transform: translateY(-50%);
                    background: var(--gradient-secondary);
                    border: 2px solid var(--oud-gold);
                    border-radius: 20px;
                    padding: 25px;
                    z-index: 16000;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: modalBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    max-width: 350px;
                    backdrop-filter: blur(10px);
                `;
                
                detailsModal.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">${status.icon}</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 10px; font-size: 1.3rem;">
                            ${user.name}
                        </h3>
                        <div style="color: var(--oud-cream); margin-bottom: 20px; font-size: 0.9rem;">
                            ${user.code} - ${employee.department}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="background: ${status.color}15; border-radius: 10px; padding: 12px; border: 1px solid ${status.color}30;">
                                <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">الحالة</div>
                                <div style="color: ${status.color}; font-weight: bold; font-size: 0.9rem;">${status.status}</div>
                            </div>
                            <div style="background: #10b98115; border-radius: 10px; padding: 12px; border: 1px solid #10b981;">
                                <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">متصل منذ</div>
                                <div style="color: #10b981; font-weight: bold; font-size: 0.9rem;">${connectionDuration} دقيقة</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="background: var(--glass-bg); border-radius: 8px; padding: 10px; border: 1px solid var(--oud-bronze);">
                                <div style="color: var(--oud-cream); font-size: 0.7rem;">الوردية</div>
                                <div style="color: var(--oud-gold); font-weight: bold; font-size: 0.8rem;">${status.scheduledShift}</div>
                            </div>
                            <div style="background: var(--glass-bg); border-radius: 8px; padding: 10px; border: 1px solid var(--oud-bronze);">
                                <div style="color: var(--oud-cream); font-size: 0.7rem;">الحضور</div>
                                <div style="color: ${status.attendanceTime !== '-' ? '#10b981' : '#6b7280'}; font-weight: bold; font-size: 0.8rem;">${status.attendanceTime}</div>
                            </div>
                        </div>
                        
                        <button onclick="this.closest('div').remove()" style="
                            background: var(--oud-bronze);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 10px;
                            font-family: 'Cairo', sans-serif;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='var(--oud-brown)'" onmouseout="this.style.background='var(--oud-bronze)'">
                            إغلاق
                        </button>
                    </div>
                `;
                
                document.body.appendChild(detailsModal);
                
                // إزالة النافذة تلقائياً بعد 10 ثوان
                setTimeout(() => {
                    if (document.body.contains(detailsModal)) {
                        detailsModal.style.animation = 'modalSlideOut 0.3s ease-in-out';
                        setTimeout(() => {
                            if (document.body.contains(detailsModal)) {
                                document.body.removeChild(detailsModal);
                            }
                        }, 300);
                    }
                }, 10000);
            },
            
            // الحصول على المستخدمين المتصلين
            getOnlineUsers() {
                return Object.keys(users).filter(username => users[username].isOnline);
            },
            
            // الحصول على عدد المتصلين
            getOnlineCount() {
                return this.getOnlineUsers().length;
            },
            
            // الحصول على المستخدمين المتصلين مع التفاصيل
            getOnlineUsersDetails() {
                return this.getOnlineUsers().map(username => ({
                    username,
                    ...users[username],
                    connectionDuration: this.getConnectionDuration(username)
                }));
            },
            
            // حساب مدة الاتصال
            getConnectionDuration(username) {
                const user = users[username];
                if (!user || !user.isOnline || !user.lastLogin) return 0;
                
                const loginTime = new Date(user.lastLogin);
                const now = new Date();
                return Math.floor((now - loginTime) / (1000 * 60)); // بالدقائق
            },
            
            // نظام النبضات المتقدم للتزامن عبر الأجهزة
            startHeartbeatSystem() {
                // إرسال نبضة كل ثانيتين
                setInterval(() => {
                    if (currentUser) {
                        const heartbeat = {
                            username: currentUser.username,
                            name: currentUser.name,
                            role: currentUser.role,
                            code: currentUser.code,
                            timestamp: new Date().toISOString(),
                            isOnline: true,
                            deviceInfo: this.getDeviceInfo(),
                            sessionId: currentUser.sessionId || this.generateSessionId()
                        };
                        
                        // حفظ النبضة في localStorage
                        localStorage.setItem(this.HEARTBEAT_KEY + '_' + currentUser.username, JSON.stringify(heartbeat));
                        
                        // تحديث البيانات العامة
                        this.updateUserStatus(currentUser.username, true);
                        
                        console.log(`💓 نبضة: ${currentUser.name} متصل`);
                    }
                }, 2000);
                
                // مراقبة نبضات الموظفين الآخرين
                setInterval(() => {
                    this.checkOtherUsersHeartbeats();
                }, 1000);
            },
            
            // فحص نبضات المستخدمين الآخرين
            checkOtherUsersHeartbeats() {
                Object.keys(users).forEach(username => {
                    if (username !== (currentUser ? currentUser.username : '')) {
                        const heartbeatKey = this.HEARTBEAT_KEY + '_' + username;
                        const heartbeatData = localStorage.getItem(heartbeatKey);
                        
                        if (heartbeatData) {
                            try {
                                const heartbeat = JSON.parse(heartbeatData);
                                const heartbeatTime = new Date(heartbeat.timestamp);
                                const now = new Date();
                                const timeDiff = (now - heartbeatTime) / 1000; // بالثواني
                                
                                // إذا كانت النبضة حديثة (أقل من 10 ثوان)
                                if (timeDiff < 10) {
                                    const wasOnline = users[username].isOnline;
                                    users[username].isOnline = true;
                                    users[username].lastActivity = heartbeat.timestamp;
                                    users[username].deviceInfo = heartbeat.deviceInfo;
                                    
                                    // إشعار المدير عند اتصال موظف جديد
                                    if (!wasOnline && currentUser && currentUser.role === 'مدير' && users[username].role !== 'مدير') {
                                        console.log(`🟢 ${heartbeat.name} متصل الآن`);
                                        this.showRealTimeNotification({
                                            username: username,
                                            isOnline: true,
                                            timestamp: heartbeat.timestamp,
                                            user: users[username],
                                            deviceInfo: heartbeat.deviceInfo
                                        });
                                    }
                                } else {
                                    // النبضة قديمة - المستخدم غير متصل
                                    if (users[username].isOnline) {
                                        users[username].isOnline = false;
                                        console.log(`🔴 ${users[username].name} غير متصل (نبضة قديمة)`);
                                    }
                                }
                            } catch (error) {
                                console.error('❌ خطأ في معالجة النبضة:', error);
                            }
                        } else {
                            // لا توجد نبضة - المستخدم غير متصل
                            if (users[username].isOnline) {
                                users[username].isOnline = false;
                                console.log(`🔴 ${users[username].name} غير متصل (لا توجد نبضة)`);
                            }
                        }
                    }
                });
                
                // تحديث الواجهة إذا كان هناك تغييرات
                if (currentUser && currentUser.role === 'مدير') {
                    this.updateManagerInterface();
                }
            },
            
            // تحديث واجهة المدير
            updateManagerInterface() {
                updateStats();
                updateAttendanceStats();
                preciseEmployeeManagement.updatePreciseEmployeeTable();
            },

            // إعداد مراقبة التغييرات عبر الأجهزة
            setupCrossDeviceMonitoring() {
                // بدء نظام النبضات
                this.startHeartbeatSystem();
                
                // مراقبة تغييرات localStorage للتزامن بين التبويبات والأجهزة
                window.addEventListener('storage', (e) => {
                    if (e.key === this.STORAGE_KEY) {
                        console.log('🔄 تم اكتشاف تغيير في بيانات الاتصال من جهاز آخر');
                        this.loadGlobalConnectionData();
                        
                        // تحديث فوري للواجهة
                        if (currentUser) {
                            setTimeout(() => {
                                updateStats();
                                updateAttendanceStats();
                                preciseEmployeeManagement.updatePreciseEmployeeTable();
                            }, 100);
                        }
                        
                        // إشعار المدير بالتغييرات
                        if (currentUser && currentUser.role === 'مدير') {
                            this.checkForNewConnections();
                        }
                    }
                    
                    // مراقبة البث المباشر
                    if (e.key === this.BROADCAST_KEY) {
                        try {
                            const broadcastData = JSON.parse(e.newValue);
                            console.log('📻 استقبال بث مباشر:', broadcastData);
                            
                            // تحديث البيانات المحلية
                            if (users[broadcastData.username]) {
                                users[broadcastData.username].isOnline = broadcastData.isOnline;
                                users[broadcastData.username].lastActivity = broadcastData.timestamp;
                                users[broadcastData.username].deviceInfo = broadcastData.deviceInfo;
                                users[broadcastData.username].sessionId = broadcastData.sessionId;
                            }
                            
                            // إشعار المدير فوراً
                            if (currentUser && currentUser.role === 'مدير' && broadcastData.username !== currentUser.username) {
                                this.showRealTimeNotification(broadcastData);
                                
                                // تحديث الواجهة
                                setTimeout(() => {
                                    updateStats();
                                    updateAttendanceStats();
                                    preciseEmployeeManagement.updatePreciseEmployeeTable();
                                }, 200);
                            }
                        } catch (error) {
                            console.error('❌ خطأ في معالجة البث:', error);
                        }
                    }
                });
                
                // مراقبة الأحداث المخصصة
                window.addEventListener('oudStatusChange', (e) => {
                    const { username, isOnline, user } = e.detail;
                    console.log(`📡 استقبال حدث تغيير حالة: ${user.name} ${isOnline ? 'متصل' : 'غير متصل'}`);
                    
                    // تحديث الواجهة فوراً
                    if (currentUser && currentUser.role === 'مدير') {
                        this.showRealTimeNotification(e.detail);
                        setTimeout(() => {
                            updateStats();
                            preciseEmployeeManagement.updatePreciseEmployeeTable();
                        }, 200);
                    }
                });
                
                // مراقبة أحداث الاتصال الجديدة
                window.addEventListener('oudConnectionUpdate', (e) => {
                    const broadcastData = e.detail;
                    console.log('🔄 تحديث اتصال مباشر:', broadcastData);
                    
                    // تحديث البيانات المحلية
                    if (users[broadcastData.username]) {
                        users[broadcastData.username].isOnline = broadcastData.isOnline;
                        users[broadcastData.username].lastActivity = broadcastData.timestamp;
                        users[broadcastData.username].deviceInfo = broadcastData.deviceInfo;
                    }
                    
                    // إشعار المدير
                    if (currentUser && currentUser.role === 'مدير' && broadcastData.username !== currentUser.username) {
                        this.showRealTimeNotification(broadcastData);
                        
                        setTimeout(() => {
                            updateStats();
                            updateAttendanceStats();
                            preciseEmployeeManagement.updatePreciseEmployeeTable();
                        }, 100);
                    }
                });
                
                // إعداد BroadcastChannel للمتصفحات الحديثة
                try {
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('oudSystem');
                        channel.addEventListener('message', (e) => {
                            const broadcastData = e.data;
                            console.log('📻 استقبال عبر BroadcastChannel:', broadcastData);
                            
                            // تحديث البيانات
                            if (users[broadcastData.username]) {
                                users[broadcastData.username].isOnline = broadcastData.isOnline;
                                users[broadcastData.username].lastActivity = broadcastData.timestamp;
                            }
                            
                            // إشعار المدير
                            if (currentUser && currentUser.role === 'مدير' && broadcastData.username !== currentUser.username) {
                                this.showRealTimeNotification(broadcastData);
                                
                                setTimeout(() => {
                                    updateStats();
                                    updateAttendanceStats();
                                    preciseEmployeeManagement.updatePreciseEmployeeTable();
                                }, 100);
                            }
                        });
                        console.log('📻 تم إعداد BroadcastChannel');
                    }
                } catch (error) {
                    console.log('⚠️ BroadcastChannel غير مدعوم');
                }
                
                // مراقبة دورية مكثفة للتغييرات (كل 3 ثوان)
                setInterval(() => {
                    this.syncWithOtherDevices();
                }, 3000);
                
                // مراقبة فورية كل ثانية للتأكد من التزامن
                setInterval(() => {
                    if (currentUser && currentUser.role === 'مدير') {
                        this.checkForNewConnections();
                    }
                }, 1000);
                
                console.log('🌐 تم إعداد مراقبة التغييرات المتقدمة عبر الأجهزة');
            },

            // مزامنة مع الأجهزة الأخرى
            syncWithOtherDevices() {
                const currentData = localStorage.getItem(this.STORAGE_KEY);
                if (currentData) {
                    const data = JSON.parse(currentData);
                    const lastUpdate = new Date(data.lastUpdate);
                    const now = new Date();
                    
                    // تحديث البيانات دائماً للتأكد من التزامن
                    this.loadGlobalConnectionData();
                    
                    // تحديث الواجهة إذا كان هناك تغييرات
                    if (currentUser) {
                        updateStats();
                        if (currentUser.role === 'مدير') {
                            preciseEmployeeManagement.updatePreciseEmployeeTable();
                            
                            // فحص الموظفين المتصلين الجدد
                            this.detectNewConnections();
                        }
                    }
                }
            },
            
            // اكتشاف الاتصالات الجديدة
            detectNewConnections() {
                const globalData = localStorage.getItem(this.STORAGE_KEY);
                if (!globalData) return;
                
                const data = JSON.parse(globalData);
                const onlineUsers = Object.keys(data.connections).filter(u => 
                    data.connections[u].isOnline && 
                    data.connections[u].role !== 'مدير' &&
                    u !== (currentUser ? currentUser.username : '')
                );
                
                // إشعار بالموظفين المتصلين
                if (onlineUsers.length > 0) {
                    console.log(`👥 الموظفين المتصلين حالياً: ${onlineUsers.length}`);
                    onlineUsers.forEach(username => {
                        const conn = data.connections[username];
                        console.log(`   🟢 ${conn.name} - ${conn.deviceInfo?.type || 'Desktop'} (${conn.deviceInfo?.browser || 'Unknown'})`);
                        
                        // إشعار المدير بالموظف المتصل
                        if (currentUser && currentUser.role === 'مدير') {
                            this.showConnectionAlert(conn);
                        }
                    });
                }
            },
            
            // عرض تنبيه الاتصال
            showConnectionAlert(employeeData) {
                // تجنب الإشعارات المتكررة
                const alertKey = `alert_${employeeData.name}_${Date.now()}`;
                if (sessionStorage.getItem(alertKey)) return;
                
                sessionStorage.setItem(alertKey, 'shown');
                setTimeout(() => sessionStorage.removeItem(alertKey), 30000); // مسح بعد 30 ثانية
                
                console.log(`🔔 تنبيه للمدير: ${employeeData.name} متصل الآن`);
                
                // إنشاء تنبيه بصري
                const alert = document.createElement('div');
                alert.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    font-family: 'Cairo', sans-serif;
                    font-weight: 600;
                    z-index: 15000;
                    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
                    animation: slideInRight 0.5s ease-out;
                    cursor: pointer;
                    border: 2px solid #34d399;
                `;
                
                alert.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 1.5rem;">🟢</div>
                        <div>
                            <div style="font-size: 1rem; font-weight: bold;">${employeeData.name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">متصل الآن - ${employeeData.deviceInfo?.type || 'Desktop'}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(alert);
                
                // إزالة التنبيه بعد 5 ثوان
                setTimeout(() => {
                    if (document.body.contains(alert)) {
                        alert.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (document.body.contains(alert)) {
                                document.body.removeChild(alert);
                            }
                        }, 300);
                    }
                }, 5000);
                
                // إزالة عند النقر
                alert.addEventListener('click', () => {
                    alert.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (document.body.contains(alert)) {
                            document.body.removeChild(alert);
                        }
                    }, 300);
                });
            },

            // فحص الاتصالات الجديدة
            checkForNewConnections() {
                const globalData = localStorage.getItem(this.STORAGE_KEY);
                if (!globalData) return;
                
                const data = JSON.parse(globalData);
                const onlineUsers = Object.keys(data.connections).filter(u => 
                    data.connections[u].isOnline && data.connections[u].role !== 'مدير'
                );
                
                // عرض إشعار بالموظفين المتصلين حالياً
                if (onlineUsers.length > 0) {
                    console.log(`👥 الموظفين المتصلين حالياً: ${onlineUsers.length}`);
                    onlineUsers.forEach(username => {
                        const conn = data.connections[username];
                        console.log(`   🟢 ${conn.name} - ${conn.deviceInfo?.type || 'Desktop'} (${conn.deviceInfo?.browser || 'Unknown'})`);
                    });
                }
            },

            // حفظ في IndexedDB للمزامنة المتقدمة
            saveToIndexedDB(data) {
                try {
                    const request = indexedDB.open('OudSystemDB', 1);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('connections')) {
                            db.createObjectStore('connections', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    
                    request.onsuccess = (e) => {
                        const db = e.target.result;
                        const transaction = db.transaction(['connections'], 'readwrite');
                        const store = transaction.objectStore('connections');
                        
                        // مسح البيانات القديمة أولاً
                        store.clear();
                        
                        // حفظ البيانات الجديدة
                        store.add({
                            ...data,
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log('💾 تم حفظ البيانات في IndexedDB للمزامنة المتقدمة');
                    };
                } catch (error) {
                    console.warn('⚠️ IndexedDB غير متاح:', error);
                }
            },

            // حفظ بيانات الاتصال (للتوافق مع الكود القديم)
            saveConnectionData() {
                this.saveGlobalConnectionData();
            },
            
            // استرداد بيانات الاتصال (للتوافق مع الكود القديم)
            loadConnectionData() {
                this.loadGlobalConnectionData();
            },
            
            // بث التحديثات لجميع الواجهات
            broadcastUpdate() {
                // تحديث الإحصائيات
                updateStats();
                updateAttendanceStats();
                preciseEmployeeManagement.updatePreciseEmployeeTable();
                
                // طباعة حالة المتصلين
                const onlineUsers = this.getOnlineUsers();
                console.log(`📡 بث التحديث - المتصلين: ${onlineUsers.length}`);
                onlineUsers.forEach(username => {
                    const duration = this.getConnectionDuration(username);
                    console.log(`   🟢 ${users[username].name} - متصل منذ ${duration} دقيقة`);
                });
            },
            
            // فحص الجلسات المنتهية الصلاحية
            checkExpiredSessions() {
                const now = new Date();
                Object.keys(users).forEach(username => {
                    const user = users[username];
                    if (user.isOnline && user.lastActivity) {
                        const lastActivity = new Date(user.lastActivity);
                        const inactiveMinutes = (now - lastActivity) / (1000 * 60);
                        
                        // إذا لم يكن نشط لأكثر من 30 دقيقة، اعتبره غير متصل
                        if (inactiveMinutes > 30) {
                            console.log(`⏰ انتهت صلاحية جلسة ${user.name} - عدم نشاط لـ ${Math.floor(inactiveMinutes)} دقيقة`);
                            this.updateUserStatus(username, false);
                        }
                    }
                });
            },
            
            // تحديث النشاط للمستخدم الحالي
            updateCurrentUserActivity() {
                if (currentUser && users[currentUser.username]) {
                    users[currentUser.username].lastActivity = new Date().toISOString();
                    this.saveConnectionData();
                }
            }
        };

        // نظام المستخدمين المحدث - جميع الحسابات مفعلة وجاهزة
        const users = {
            // حسابات الموظفين - أسماء المستخدمين الصحيحة
            'badr': {
                password: '123',
                role: 'موظف',
                name: 'بدر ناصر',
                code: '7177',
                employeeId: 'EMP001',
                department: 'خدمة عملاء نخبة العود',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            'saad': {
                password: '123',
                role: 'موظف',
                name: 'سعد سنبل',
                code: '5472',
                employeeId: 'EMP002',
                department: 'خدمة عملاء نخبة العود',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            'hussein': {
                password: '123',
                role: 'موظف',
                name: 'حسين الحربي',
                code: '9058',
                employeeId: 'EMP003',
                department: 'خدمة عملاء نخبة العود',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            'ahmed': {
                password: '123',
                role: 'موظف',
                name: 'احمد العنزي',
                code: '12694',
                employeeId: 'EMP004',
                department: 'المبيعات',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            'yazeed': {
                password: '123',
                role: 'موظف',
                name: 'يزيد النعيمي',
                code: '10449',
                employeeId: 'EMP005',
                department: 'الإدارة',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            'noura': {
                password: '123',
                role: 'موظف',
                name: 'نورة فيصل',
                code: '15104',
                employeeId: 'EMP006',
                department: 'التسويق',
                permissions: ['dashboard', 'attendance'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0
            },
            // حساب المدير
            'admin': {
                password: '123',
                role: 'مدير',
                name: 'مدير النظام',
                code: 'ADMIN',
                employeeId: 'ADMIN001',
                department: 'الإدارة العليا',
                permissions: ['dashboard', 'schedule', 'employees', 'attendance', 'reports', 'settings'],
                isActive: true,
                isOnline: false,
                lastLogin: null,
                loginCount: 0,
                isAdmin: true
            }
        };

        // طباعة بيانات تسجيل الدخول للتأكد
        console.log('🔑 أسماء المستخدمين المتاحة:');
        Object.keys(users).forEach(username => {
            console.log(`   ${username} -> ${users[username].name} (${users[username].role})`);
        });
        console.log('📝 كلمة المرور لجميع الحسابات: 123');

        // طباعة أسماء المستخدمين المتاحة للتأكد
        console.log('🔑 أسماء المستخدمين المتاحة:', Object.keys(users));
        console.log('📝 جميع كلمات المرور: 123');

        let currentUser = null;

        // نظام إدارة الجلسات مع مزامنة الإنترنت
        const sessionManager = {
            // حفظ الجلسة مع مزامنة الإنترنت
            saveSession(user) {
                const sessionData = {
                    username: user.username,
                    loginTime: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    isOnline: navigator.onLine,
                    ...user
                };
                
                // حفظ محلي
                localStorage.setItem('oudUserSession', JSON.stringify(sessionData));
                
                // محاولة المزامنة مع الخادم (محاكاة)
                this.syncWithServer(sessionData);
                
                console.log('💾 تم حفظ الجلسة:', user.name);
            },

            // مزامنة البيانات مع الخادم (محاكاة للعمل على الإنترنت)
            syncWithServer(sessionData) {
                // محاكاة إرسال البيانات للخادم
                if (navigator.onLine) {
                    console.log('🌐 مزامنة البيانات مع الخادم...');
                    
                    // محاكاة API call
                    const syncData = {
                        action: 'updateUserStatus',
                        username: sessionData.username,
                        isOnline: sessionData.isOnline,
                        timestamp: sessionData.lastActivity,
                        userAgent: navigator.userAgent,
                        platform: navigator.platform
                    };
                    
                    // حفظ في IndexedDB للمزامنة اللاحقة
                    this.saveToIndexedDB(syncData);
                    
                    console.log('✅ تم إرسال البيانات للخادم (محاكاة)');
                } else {
                    console.log('📴 لا يوجد اتصال بالإنترنت - سيتم المزامنة لاحقاً');
                    this.queueForLaterSync(sessionData);
                }
            },

            // حفظ في IndexedDB للمزامنة المتقدمة
            saveToIndexedDB(data) {
                try {
                    const request = indexedDB.open('OudSystemDB', 1);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('sessions')) {
                            db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    
                    request.onsuccess = (e) => {
                        const db = e.target.result;
                        const transaction = db.transaction(['sessions'], 'readwrite');
                        const store = transaction.objectStore('sessions');
                        
                        store.add({
                            ...data,
                            timestamp: new Date().toISOString(),
                            synced: false
                        });
                        
                        console.log('💾 تم حفظ البيانات في IndexedDB');
                    };
                } catch (error) {
                    console.warn('⚠️ IndexedDB غير متاح:', error);
                }
            },

            // إضافة للطابور للمزامنة اللاحقة
            queueForLaterSync(data) {
                const queue = JSON.parse(localStorage.getItem('oudSyncQueue') || '[]');
                queue.push({
                    ...data,
                    queuedAt: new Date().toISOString()
                });
                localStorage.setItem('oudSyncQueue', JSON.stringify(queue));
                console.log('📋 تم إضافة البيانات لطابور المزامنة');
            },

            // مزامنة البيانات المؤجلة عند عودة الاتصال
            syncQueuedData() {
                if (!navigator.onLine) return;
                
                const queue = JSON.parse(localStorage.getItem('oudSyncQueue') || '[]');
                if (queue.length === 0) return;
                
                console.log(`🔄 مزامنة ${queue.length} عنصر من الطابور...`);
                
                queue.forEach((item, index) => {
                    // محاكاة إرسال البيانات
                    setTimeout(() => {
                        console.log(`✅ تم مزامنة العنصر ${index + 1}/${queue.length}`);
                        
                        // إزالة العنصر من الطابور بعد المزامنة
                        if (index === queue.length - 1) {
                            localStorage.removeItem('oudSyncQueue');
                            console.log('🎉 تم مزامنة جميع البيانات المؤجلة');
                        }
                    }, index * 500);
                });
            },

            // استرداد الجلسة
            restoreSession() {
                try {
                    const sessionData = localStorage.getItem('oudUserSession');
                    if (!sessionData) return null;

                    const session = JSON.parse(sessionData);
                    
                    // التحقق من صحة الجلسة (24 ساعة)
                    const loginTime = new Date(session.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        this.clearSession();
                        return null;
                    }

                    // تحديث آخر نشاط
                    session.lastActivity = now.toISOString();
                    localStorage.setItem('oudUserSession', JSON.stringify(session));
                    
                    console.log('🔄 تم استرداد الجلسة:', session.name);
                    return session;
                } catch (error) {
                    console.error('❌ خطأ في استرداد الجلسة:', error);
                    this.clearSession();
                    return null;
                }
            },

            // مسح الجلسة
            clearSession() {
                localStorage.removeItem('oudUserSession');
                console.log('🗑️ تم مسح الجلسة');
            },

            // تحديث آخر نشاط
            updateActivity() {
                const sessionData = localStorage.getItem('oudUserSession');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    session.lastActivity = new Date().toISOString();
                    localStorage.setItem('oudUserSession', JSON.stringify(session));
                }
            }
        };

        // بيانات الموظفين مع الجدولة الدقيقة لأغسطس 2025
        const employeesData = [
            {
                id: 1,
                name: 'بدر ناصر',
                code: 'EMP001',
                username: 'emp001',
                department: 'خدمة عملاء نخبة العود',
                hireDate: '2024-01-15',
                performance: 95,
                salary: 5000,
                schedule: ['OFF', 'OFF', '4-10', '4-10', '4-10', '4-10', '4-10', 'OFF', 'OFF', '4-10', '4-10', '4-10', '4-10', '4-10', 'OFF', 'OFF', '4-10', '4-10', '4-10', '4-10', '4-10', 'OFF', 'OFF', '4-10', '4-10', '4-10', '4-10', '4-10', 'OFF', 'OFF']
            },
            {
                id: 2,
                name: 'سعد سنبل',
                code: 'EMP002',
                username: 'emp002',
                department: 'خدمة عملاء نخبة العود',
                hireDate: '2024-02-01',
                performance: 88,
                salary: 4500,
                schedule: ['OFF', 'OFF', '9-3', '9-3', '9-3', '9-3', '9-3', 'OFF', 'OFF', '9-3', '9-3', '9-3', '9-3', '9-3', 'OFF', 'OFF', '9-3', '9-3', '9-3', '9-3', '9-3', 'OFF', 'OFF', '9-3', '9-3', '9-3', '9-3', '9-3', 'OFF', 'OFF']
            },
            {
                id: 3,
                name: 'حسين الحربي',
                code: 'EMP003',
                username: 'emp003',
                department: 'خدمة عملاء نخبة العود',
                hireDate: '2024-01-20',
                performance: 92,
                salary: 4800,
                schedule: ['OFF', 'OFF', '9-6', '9-6', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '9-6', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '9-6', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '9-6', '9-6', '9-6', '9-6', 'OFF', 'OFF']
            },
            {
                id: 4,
                name: 'احمد العنزي',
                code: 'EMP004',
                username: 'emp004',
                department: 'المبيعات',
                hireDate: '2024-03-10',
                performance: 90,
                salary: 5200,
                schedule: ['1-10', '11-8', 'OFF', 'OFF', '11-8', '11-8', '11-8', '1-10', '11-8', 'OFF', 'OFF', '11-8', '11-8', '11-8', '1-10', '11-8', 'OFF', 'OFF', '11-8', '11-8', '11-8', '1-10', '11-8', 'OFF', 'OFF', '11-8', '11-8', '11-8', '1-10', '11-8']
            },
            {
                id: 5,
                name: 'يزيد النعيمي',
                code: 'EMP005',
                username: 'emp005',
                department: 'الإدارة',
                hireDate: '2023-12-01',
                performance: 85,
                salary: 6000,
                schedule: ['1-10', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '1-10', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '1-10', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '1-10', '9-6', '9-6', '9-6', 'OFF', 'OFF', '9-6', '1-10', '9-6']
            },
            {
                id: 6,
                name: 'نورة فيصل',
                code: 'EMP006',
                username: 'emp006',
                department: 'التسويق',
                hireDate: '2024-01-05',
                performance: 87,
                salary: 4700,
                schedule: ['1-10', '1-10', '1-10', '1-10', '1-10', 'OFF', 'OFF', '1-10', '1-10', '1-10', '1-10', '1-10', 'OFF', 'OFF', '1-10', '1-10', '1-10', '1-10', '1-10', 'OFF', 'OFF', '1-10', '1-10', '1-10', '1-10', '1-10', 'OFF', 'OFF', '1-10', '1-10']
            }
        ];

        // نظام إدارة الموظفين الدقيق والمتقدم
        const preciseEmployeeManagement = {
            // الحصول على فهرس اليوم الحالي في الجدولة (0-29)
            getCurrentDayIndex() {
                const today = new Date();
                const startDate = new Date('2025-08-01'); // تاريخ بداية الجدولة - أغسطس 2025
                const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                return Math.max(0, Math.min(29, daysDiff)); // محدود بين 0-29 (30 يوم)
            },

            // تحديد الحالة الدقيقة للموظف حسب الجدول والنظام
            getPreciseEmployeeStatus(employee) {
                const dayIndex = this.getCurrentDayIndex();
                const todayShift = employee.schedule[dayIndex];
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                
                // التحقق من حالة الاتصال الفعلية من نظام تتبع الاتصال
                const isActuallyOnline = username && users[username] && users[username].isOnline === true;
                
                // التحقق من تسجيل الدخول في النظام (المستخدم الحالي)
                const isCurrentUser = currentUser && currentUser.username === username;
                
                // التحقق من بيانات الحضور
                const attendanceData = attendanceSystem.attendanceData[attendanceSystem.currentDate] || {};
                const userAttendance = attendanceData[username];
                
                // إجازة سنوية
                if (todayShift === 'Annual') {
                    return {
                        status: 'إجازة سنوية',
                        color: '#f97316',
                        icon: '🏖️',
                        type: 'annualLeave',
                        isWorkDay: false,
                        isLoggedIn: isActuallyOnline,
                        scheduledShift: 'إجازة سنوية',
                        attendanceTime: '-',
                        systemStatus: isActuallyOnline ? 'متصل الآن' : 'غير متصل',
                        connectionStatus: isActuallyOnline ? 'online' : 'offline'
                    };
                } 
                // إجازة أسبوعية (راحة)
                else if (todayShift === 'OFF') {
                    return {
                        status: 'إجازة أسبوعية',
                        color: '#6b7280',
                        icon: '💤',
                        type: 'weeklyLeave',
                        isWorkDay: false,
                        isLoggedIn: isActuallyOnline,
                        scheduledShift: 'إجازة أسبوعية',
                        attendanceTime: '-',
                        systemStatus: isActuallyOnline ? 'متصل الآن' : 'غير متصل',
                        connectionStatus: isActuallyOnline ? 'online' : 'offline'
                    };
                } 
                // يوم عمل مجدول
                else {
                    // حاضر ومباشر (متصل + حضور)
                    if (isActuallyOnline && userAttendance && userAttendance.checkIn && !userAttendance.checkOut) {
                        return {
                            status: 'حاضر ومباشر',
                            color: '#10b981',
                            icon: '✅',
                            type: 'present',
                            isWorkDay: true,
                            isLoggedIn: true,
                            scheduledShift: todayShift,
                            attendanceTime: userAttendance.checkIn,
                            systemStatus: 'متصل ويعمل',
                            connectionStatus: 'online',
                            isLate: userAttendance.isLate || false
                        };
                    }
                    // منصرف (متصل + انصراف)
                    else if (isActuallyOnline && userAttendance && userAttendance.checkOut) {
                        return {
                            status: 'منصرف',
                            color: '#3b82f6',
                            icon: '🏠',
                            type: 'finished',
                            isWorkDay: true,
                            isLoggedIn: true,
                            scheduledShift: todayShift,
                            attendanceTime: userAttendance.checkIn,
                            systemStatus: 'متصل (منصرف)',
                            connectionStatus: 'online',
                            workingHours: userAttendance.workingHours || 0
                        };
                    }
                    // متصل فقط (بدون حضور)
                    else if (isActuallyOnline && (!userAttendance || !userAttendance.checkIn)) {
                        return {
                            status: 'متصل (لم يسجل حضور)',
                            color: '#8b5cf6',
                            icon: '🔐',
                            type: 'loggedIn',
                            isWorkDay: true,
                            isLoggedIn: true,
                            scheduledShift: todayShift,
                            attendanceTime: '-',
                            systemStatus: 'متصل الآن',
                            connectionStatus: 'online'
                        };
                    }
                    // حضور بدون اتصال
                    else if (!isActuallyOnline && userAttendance && userAttendance.checkIn) {
                        return {
                            status: 'حاضر (غير متصل)',
                            color: '#f59e0b',
                            icon: '⚠️',
                            type: 'attendanceOnly',
                            isWorkDay: true,
                            isLoggedIn: false,
                            scheduledShift: todayShift,
                            attendanceTime: userAttendance.checkIn,
                            systemStatus: 'غير متصل',
                            connectionStatus: 'offline'
                        };
                    }
                    // غير متصل تماماً
                    else {
                        return {
                            status: 'غير متصل',
                            color: '#6b7280',
                            icon: '🔌',
                            type: 'offline',
                            isWorkDay: true,
                            isLoggedIn: false,
                            scheduledShift: todayShift,
                            attendanceTime: '-',
                            systemStatus: 'غير متصل',
                            connectionStatus: 'offline'
                        };
                    }
                }
            },

            // حساب الإحصائيات الدقيقة
            calculatePreciseStats() {
                let presentCount = 0;
                let weeklyLeaveCount = 0;
                let annualLeaveCount = 0;
                let loggedInCount = 0;
                
                // فلترة الموظفين لاستبعاد المدير
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });
                
                regularEmployees.forEach(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    const status = this.getPreciseEmployeeStatus(employee);
                    
                    switch (status.type) {
                        case 'present':
                        case 'finished':
                        case 'attendanceOnly':
                            presentCount++;
                            break;
                        case 'weeklyLeave':
                            weeklyLeaveCount++;
                            break;
                        case 'annualLeave':
                            annualLeaveCount++;
                            break;
                        case 'offline':
                            // لا نحسب غير المتصلين في الإحصائيات
                            break;
                    }
                    
                    // فحص حالة الاتصال الفعلية من بيانات المستخدمين
                    if (username && users[username] && users[username].isOnline) {
                        loggedInCount++;
                        console.log(`🟢 ${employee.name} متصل في النظام`);
                    }
                });
                
                console.log(`📊 إحصائيات دقيقة - متصلين: ${loggedInCount}، حاضرين: ${presentCount}`);
                
                return {
                    presentCount,
                    weeklyLeaveCount,
                    annualLeaveCount,
                    loggedInCount,
                    totalEmployees: regularEmployees.length
                };
            },

            // الحصول على قائمة الموظفين حسب النوع
            getEmployeesByType(type) {
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });
                
                return regularEmployees.filter(employee => {
                    const status = this.getPreciseEmployeeStatus(employee);
                    
                    switch (type) {
                        case 'present':
                            return status.type === 'present' || status.type === 'finished' || status.type === 'attendanceOnly';
                        case 'weeklyLeave':
                            return status.type === 'weeklyLeave';
                        case 'annualLeave':
                            return status.type === 'annualLeave';
                        case 'loggedIn':
                            return status.isLoggedIn;
                        case 'offline':
                            return status.type === 'offline';
                        default:
                            return false;
                    }
                }).map(employee => ({
                    ...employee,
                    statusDetails: this.getPreciseEmployeeStatus(employee)
                }));
            },

            // تحديث جدول الموظفين الدقيق
            updatePreciseEmployeeTable() {
                const tbody = document.getElementById('preciseEmployeeTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // فلترة الموظفين لاستبعاد المدير
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });
                
                regularEmployees.forEach(employee => {
                    const status = this.getPreciseEmployeeStatus(employee);
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    const row = document.createElement('tr');
                    
                    // تلوين الصف حسب الحالة
                    let rowStyle = `background: ${status.color}15;`;
                    row.style.cssText = rowStyle;
                    
                    // تحديد لون وحالة الاتصال
                    const connectionColor = status.connectionStatus === 'online' ? '#10b981' : '#ef4444';
                    const connectionIcon = status.connectionStatus === 'online' ? '🟢' : '🔴';
                    const connectionText = status.connectionStatus === 'online' ? 'متصل الآن' : 'غير متصل';
                    
                    // إضافة مؤشر نبض للمتصلين
                    const pulseAnimation = status.connectionStatus === 'online' ? 'animation: pulse 2s infinite;' : '';
                    
                    row.innerHTML = `
                        <td style="font-weight: bold;">${employee.name}</td>
                        <td style="color: var(--oud-gold); font-weight: bold;">${employee.code}</td>
                        <td>${employee.department}</td>
                        <td style="font-weight: bold;">${status.scheduledShift}</td>
                        <td>
                            <span style="background: ${status.color}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; font-weight: bold;">
                                ${status.icon} ${status.status}
                            </span>
                            ${status.isLate ? '<div style="color: #f59e0b; font-size: 0.8rem; margin-top: 4px;">⚠️ متأخر</div>' : ''}
                        </td>
                        <td style="font-weight: bold; color: ${status.attendanceTime !== '-' ? '#10b981' : '#6b7280'};">
                            ${status.attendanceTime}
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="background: ${connectionColor}; color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 4px; ${pulseAnimation}">
                                    ${connectionIcon} ${connectionText}
                                </span>
                                ${status.connectionStatus === 'online' ? `
                                    <div style="color: #10b981; font-size: 0.7rem; font-weight: bold;">
                                        🔥 نشط الآن
                                    </div>
                                ` : `
                                    <div style="color: #6b7280; font-size: 0.7rem;">
                                        📴 غير نشط
                                    </div>
                                `}
                            </div>
                        </td>
                        <td>
                            <button class="oud-btn oud-btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="viewEmployeeDetails(${employee.id})">
                                <span>👁️</span> عرض
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // إضافة تأثير النبض للمتصلين
                const style = document.createElement('style');
                style.id = 'pulseAnimation';
                if (!document.getElementById('pulseAnimation')) {
                    style.textContent = `
                        @keyframes pulse {
                            0%, 100% { 
                                opacity: 1; 
                                transform: scale(1);
                            }
                            50% { 
                                opacity: 0.8; 
                                transform: scale(1.05);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        };

        // نظام تحديد حالة الموظفين الذكي المتقدم (للتوافق مع الكود الموجود)
        const employeeStatusSystem = {
            // الحصول على فهرس اليوم الحالي في الجدولة (0-19)
            getCurrentDayIndex() {
                return preciseEmployeeManagement.getCurrentDayIndex();
            },

            // تحديد حالة الموظف اليوم بدقة عالية
            getEmployeeStatus(employee) {
                const status = preciseEmployeeManagement.getPreciseEmployeeStatus(employee);
                
                // تحويل للتنسيق القديم للتوافق
                return {
                    status: status.status,
                    color: status.color,
                    icon: status.icon,
                    isWorkDay: status.isWorkDay,
                    checkInTime: status.attendanceTime,
                    isLate: status.isLate || false,
                    workingHours: status.workingHours || 0,
                    scheduledShift: status.scheduledShift
                };
            },

            // حساب معدل الحضور الدقيق للموظف
            calculateAttendanceRate(employee) {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                if (!username) return 0;
                
                let workDays = 0;
                let attendedDays = 0;
                
                // فحص آخر 30 يوم من البيانات
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    // تحديد إذا كان يوم عمل مجدول
                    const dayIndex = this.getDayIndexForDate(checkDate);
                    if (dayIndex >= 0 && dayIndex < 20) {
                        const shift = employee.schedule[dayIndex];
                        if (shift !== 'OFF' && shift !== 'Annual') {
                            workDays++;
                            
                            // فحص الحضور
                            const dayData = attendanceSystem.attendanceData[dateStr];
                            if (dayData && (dayData[username] || dayData[employee.name] || dayData[employee.code])) {
                                const attendance = dayData[username] || dayData[employee.name] || dayData[employee.code];
                                if (attendance.checkIn) {
                                    attendedDays++;
                                }
                            }
                        }
                    }
                }
                
                return workDays > 0 ? Math.round((attendedDays / workDays) * 100) : 0;
            },

            // الحصول على فهرس اليوم لتاريخ محدد
            getDayIndexForDate(date) {
                const startDate = new Date('2025-08-01');
                const daysDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
                return daysDiff >= 0 && daysDiff < 30 ? daysDiff : -1;
            },

            // الحصول على إحصائيات الموظفين الدقيقة (بدون المدير)
            getEmployeeStats() {
                let present = 0;
                let absent = 0;
                let onLeave = 0;
                let onBreak = 0;
                let totalAttendanceRate = 0;
                let employeeCount = 0;

                // فلترة الموظفين لاستبعاد المدير
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });

                regularEmployees.forEach(employee => {
                    const status = this.getEmployeeStatus(employee);
                    const attendanceRate = this.calculateAttendanceRate(employee);
                    
                    employeeCount++;
                    totalAttendanceRate += attendanceRate;
                    
                    if (status.status === 'حاضر' || status.status === 'منصرف') {
                        present++;
                    } else if (status.status === 'غير متصل' && status.isWorkDay) {
                        absent++;
                    } else if (status.status === 'إجازة') {
                        onLeave++;
                    } else if (status.status === 'إجازة أسبوعية') {
                        onBreak++;
                    }
                });

                return {
                    present,
                    absent,
                    onLeave,
                    onBreak,
                    averageAttendanceRate: employeeCount > 0 ? Math.round(totalAttendanceRate / employeeCount) : 0,
                    totalEmployees: employeeCount
                };
            },

            // الحصول على قائمة الموظفين حسب الحالة مع تفاصيل إضافية
            getEmployeesByStatus(statusType) {
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });

                return regularEmployees.filter(employee => {
                    const status = this.getEmployeeStatus(employee);
                    const attendanceRate = this.calculateAttendanceRate(employee);
                    
                    // إضافة معدل الحضور للموظف
                    employee.attendanceRate = attendanceRate;
                    employee.currentStatus = status;
                    
                    switch (statusType) {
                        case 'present':
                            return status.status === 'حاضر' || status.status === 'منصرف';
                        case 'absent':
                            return status.status === 'غير متصل' && status.isWorkDay;
                        case 'onLeave':
                            return status.status === 'إجازة';
                        case 'excellent':
                            return attendanceRate >= 95; // معدل حضور ممتاز
                        default:
                            return false;
                    }
                }).map(employee => ({
                    ...employee,
                    statusDetails: this.getEmployeeStatus(employee),
                    attendanceRate: this.calculateAttendanceRate(employee)
                }));
            }
        };

        // تحديث الوقت
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const dateString = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const currentTimeEl = document.getElementById('currentTime');
            const currentDateEl = document.getElementById('currentDate');
            
            if (currentTimeEl) {
                currentTimeEl.textContent = timeString;
            }
            
            if (currentDateEl) {
                currentDateEl.textContent = dateString;
            }
            
            updateClockHands(now);
        }
        
        function updateClockHands(now) {
            const hours = now.getHours() % 12;
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            const hourAngle = (hours * 30) + (minutes * 0.5);
            const minuteAngle = minutes * 6;
            const secondAngle = seconds * 6;
            
            const clock = document.querySelector('.ai-clock');
            if (clock) {
                clock.style.setProperty('--hour-angle', `${hourAngle}deg`);
                clock.style.setProperty('--minute-angle', `${minuteAngle}deg`);
                clock.style.setProperty('--second-angle', `${secondAngle}deg`);
            }
        }

        // تحديث الإحصائيات الذكية والدقيقة
        function updateStats() {
            // حساب الحاضرين الفعليين من بيانات الحضور والاتصال
            let actualPresentCount = 0;
            let totalEmployeesCount = 0;
            let absentCount = 0;
            
            // فلترة الموظفين لاستبعاد المدير
            const regularEmployees = employeesData.filter(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                return username && users[username].role !== 'مدير';
            });
            
            totalEmployeesCount = regularEmployees.length;
            
            // حساب الحاضرين من بيانات الحضور الفعلية
            const todayData = attendanceSystem.attendanceData[attendanceSystem.currentDate] || {};
            
            regularEmployees.forEach(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                if (username) {
                    const attendance = todayData[username];
                    const isLoggedIn = users[username].isOnline;
                    
                    // الموظف حاضر إذا:
                    // 1. سجل حضور اليوم، أو
                    // 2. مسجل دخول في النظام ومجدول للعمل اليوم
                    const hasAttendance = attendance && attendance.checkIn;
                    const dayIndex = employeeStatusSystem.getCurrentDayIndex();
                    const todayShift = employee.schedule[dayIndex];
                    const isWorkDay = todayShift !== 'OFF' && todayShift !== 'Annual';
                    
                    if (hasAttendance || (isLoggedIn && isWorkDay)) {
                        actualPresentCount++;
                    } else if (isWorkDay) {
                        absentCount++;
                    }
                }
            });
            
            // تحديث الإحصائيات الرئيسية
            document.getElementById('totalEmployees').textContent = totalEmployeesCount;
            document.getElementById('presentToday').textContent = actualPresentCount;
            document.getElementById('absentToday').textContent = absentCount;
            
            // حساب معدل الحضور
            const attendanceRate = totalEmployeesCount > 0 ? Math.round((actualPresentCount / totalEmployeesCount) * 100) : 0;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            
            // تحديث إحصائيات إدارة الموظفين الدقيقة
            const preciseStats = preciseEmployeeManagement.calculatePreciseStats();
            if (document.getElementById('actualPresentCount')) {
                document.getElementById('actualPresentCount').textContent = actualPresentCount;
                document.getElementById('weeklyLeaveCount').textContent = preciseStats.weeklyLeaveCount;
                document.getElementById('annualLeaveCount').textContent = preciseStats.annualLeaveCount;
                
                // عدد المتصلين فعلياً
                const actualOnlineCount = connectionTracker.getOnlineCount();
                document.getElementById('loggedInCount').textContent = actualOnlineCount;
                
                console.log(`📊 تحديث الإحصائيات - الحاضرين: ${actualPresentCount}، المتصلين: ${actualOnlineCount}`);
            }
            
            // تحديث إحصائيات الحضور أيضاً
            if (document.getElementById('totalEmployeesCount')) {
                updateAttendanceStats();
            }
            
            // تحديث جدول الموظفين العادي والدقيق
            updateEmployeeTable();
            preciseEmployeeManagement.updatePreciseEmployeeTable();
            
            // تحديث تقارير التأخير
            if (document.getElementById('lateReportTableBody')) {
                updateLateReports();
            }
        }

        // تحديث جدول الموظفين المتقدم (بدون المدير)
        function updateEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // فلترة الموظفين لاستبعاد المدير
            const regularEmployees = employeesData.filter(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                return username && users[username].role !== 'مدير';
            });
            
            regularEmployees.forEach((employee, index) => {
                const status = employeeStatusSystem.getEmployeeStatus(employee);
                const attendanceRate = employeeStatusSystem.calculateAttendanceRate(employee);
                const row = document.createElement('tr');
                
                // تلوين الصف حسب معدل الحضور
                let rowStyle = '';
                if (attendanceRate >= 95) {
                    rowStyle = 'background: rgba(16, 185, 129, 0.1);'; // أخضر للممتاز
                } else if (attendanceRate >= 85) {
                    rowStyle = 'background: rgba(59, 130, 246, 0.1);'; // أزرق للجيد
                } else if (attendanceRate >= 70) {
                    rowStyle = 'background: rgba(245, 158, 11, 0.1);'; // أصفر للمتوسط
                } else {
                    rowStyle = 'background: rgba(239, 68, 68, 0.1);'; // أحمر للضعيف
                }
                
                row.style.cssText = rowStyle;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-weight: bold;">${employee.name}</td>
                    <td>${employee.code}</td>
                    <td>${employee.department}</td>
                    <td>
                        <span style="background: ${status.color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 4px;">
                            ${status.icon} ${status.status}
                        </span>
                        ${status.isLate ? '<div style="color: #f59e0b; font-size: 0.7rem; margin-top: 2px;">⚠️ متأخر</div>' : ''}
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-weight: bold; color: ${attendanceRate >= 90 ? '#10b981' : attendanceRate >= 70 ? '#f59e0b' : '#ef4444'};">
                                ${attendanceRate}%
                            </div>
                            <div style="width: 50px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${attendanceRate}%; height: 100%; background: ${attendanceRate >= 90 ? '#10b981' : attendanceRate >= 70 ? '#f59e0b' : '#ef4444'}; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="oud-btn oud-btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="viewEmployeeDetails(${employee.id})">
                            <span>👁️</span> عرض
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // عرض الموظفين حسب الحالة الدقيقة
        function showEmployeesByStatus(statusType) {
            const employees = preciseEmployeeManagement.getEmployeesByType(statusType);
            
            let title = '';
            let icon = '';
            
            switch (statusType) {
                case 'present':
                    title = 'الموظفين الحاضرين والمباشرين';
                    icon = '✅';
                    break;
                case 'weeklyLeave':
                    title = 'الموظفين في إجازة أسبوعية';
                    icon = '💤';
                    break;
                case 'annualLeave':
                    title = 'الموظفين في إجازة سنوية';
                    icon = '🏖️';
                    break;
                case 'loggedIn':
                    title = 'الموظفين المسجلين في النظام';
                    icon = '🔐';
                    break;
                default:
                    title = 'قائمة الموظفين';
                    icon = '👥';
            }
            
            showPreciseEmployeeModal(title, employees, icon);
        }

        // عرض نافذة الموظفين الدقيقة
        function showPreciseEmployeeModal(title, employees, icon) {
            const modalTitle = document.getElementById('statusModalTitle');
            const modalContent = document.getElementById('employeeStatusContent');
            
            modalTitle.innerHTML = `${icon} ${title}`;
            
            if (employees.length === 0) {
                modalContent.innerHTML = `
                    <div style="padding: 50px; text-align: center; color: var(--oud-cream);">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">${icon}</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px;">لا توجد بيانات</h3>
                        <p style="opacity: 0.8;">لا يوجد موظفين في هذه الفئة حالياً</p>
                    </div>
                `;
            } else {
                let content = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                `;
                
                employees.forEach(employee => {
                    const status = employee.statusDetails;
                    
                    content += `
                        <div style="background: var(--glass-bg); border-radius: 15px; padding: 25px; border: 2px solid ${status.color}30; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <div style="width: 60px; height: 60px; background: ${status.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-left: 20px; box-shadow: 0 4px 15px ${status.color}40;">
                                    ${status.icon}
                                </div>
                                <div>
                                    <h4 style="color: var(--oud-gold); margin: 0; font-size: 1.2rem; font-weight: bold;">${employee.name}</h4>
                                    <p style="color: var(--oud-cream); margin: 3px 0; font-size: 1rem; font-weight: 600;">${employee.code}</p>
                                    <p style="color: var(--oud-bronze); margin: 0; font-size: 0.9rem;">${employee.department}</p>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="text-align: center; padding: 12px; background: ${status.color}15; border-radius: 10px; border: 1px solid ${status.color}30;">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">الحالة الفعلية</div>
                                    <div style="color: ${status.color}; font-weight: bold; font-size: 0.9rem;">${status.status}</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--oud-bronze);">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">الوردية</div>
                                    <div style="color: var(--oud-gold); font-weight: bold; font-size: 0.9rem;">${status.scheduledShift}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="text-align: center; padding: 12px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--oud-bronze);">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">وقت الحضور</div>
                                    <div style="color: ${status.attendanceTime !== '-' ? '#10b981' : '#6b7280'}; font-weight: bold; font-size: 0.9rem;">${status.attendanceTime}</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: ${status.isLoggedIn ? '#10b98115' : '#6b728015'}; border-radius: 10px; border: 1px solid ${status.isLoggedIn ? '#10b981' : '#6b7280'};">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">حالة النظام</div>
                                    <div style="color: ${status.isLoggedIn ? '#10b981' : '#6b7280'}; font-weight: bold; font-size: 0.9rem;">${status.systemStatus}</div>
                                </div>
                            </div>
                            
                            ${status.isLate ? `
                                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                                    <div style="color: #f59e0b; font-weight: bold; font-size: 0.8rem; text-align: center;">⚠️ متأخر</div>
                                </div>
                            ` : ''}
                            
                            <button class="oud-btn oud-btn-primary" style="width: 100%; padding: 10px; font-size: 0.9rem;" onclick="viewEmployeeDetails(${employee.id}); closeModal('employeeStatusModal');">
                                <span>👁️</span> عرض التفاصيل الكاملة
                            </button>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--oud-bronze);">
                            <div style="color: var(--oud-cream); font-size: 1rem;">
                                إجمالي: <span style="color: var(--oud-gold); font-weight: bold; font-size: 1.2rem;">${employees.length}</span> موظف
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = content;
            openModal('employeeStatusModal');
        }

        // الدوال القديمة للتوافق
        function showPresentEmployees() {
            showEmployeesByStatus('present');
        }

        function showAbsentEmployees() {
            const absentEmployees = employeeStatusSystem.getEmployeesByStatus('absent');
            showEmployeeStatusModal('الموظفين الغائبين اليوم', absentEmployees, '❌');
        }

        function showOnLeaveEmployees() {
            showEmployeesByStatus('annualLeave');
        }

        function showExcellentEmployees() {
            const excellentEmployees = employeeStatusSystem.getEmployeesByStatus('excellent');
            showEmployeeStatusModal('الموظفين المتميزين', excellentEmployees, '⭐');
        }

        // عرض الموظفين المتصلين للمدير فقط مع نظام تتبع الاتصال المتقدم
        function showPresentEmployeesForAdmin() {
            if (!currentUser || currentUser.role !== 'مدير') return;
            
            console.log('🔍 فحص الموظفين المتصلين للمدير باستخدام نظام تتبع الاتصال...');
            
            // الحصول على جميع الموظفين المتصلين فعلياً من نظام تتبع الاتصال
            const onlineUsers = connectionTracker.getOnlineUsersDetails();
            const connectedEmployees = [];
            
            onlineUsers.forEach(user => {
                if (user.role !== 'مدير') {
                    // البحث عن بيانات الموظف
                    const employee = employeesData.find(emp => {
                        const empUsername = Object.keys(users).find(u => users[u].name === emp.name);
                        return empUsername === user.username;
                    });
                    
                    if (employee) {
                        const status = preciseEmployeeManagement.getPreciseEmployeeStatus(employee);
                        connectedEmployees.push({
                            ...employee,
                            username: user.username,
                            statusDetails: status,
                            user: user,
                            connectionDuration: user.connectionDuration,
                            lastActivity: user.lastActivity
                        });
                        console.log(`✅ موظف متصل: ${user.name} - ${status.status} - متصل منذ ${user.connectionDuration} دقيقة`);
                    }
                }
            });
            
            console.log(`👥 إجمالي الموظفين المتصلين: ${connectedEmployees.length}`);
            
            if (connectedEmployees.length === 0) {
                console.log('ℹ️ لا يوجد موظفين متصلين حالياً');
                return;
            }
            
            // عرض النافذة تلقائياً بعد ثانيتين
            setTimeout(() => {
                showPresentEmployeesModal(connectedEmployees);
            }, 2000);
        }
        
        // عرض نافذة الموظفين المتصلين
        function showPresentEmployeesModal(employees) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '4000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3 class="modal-title">👥 الموظفين المتصلين الآن (${employees.length})</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                            ${employees.map(employee => `
                                <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; border: 2px solid ${employee.statusDetails.color}30; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <div style="width: 60px; height: 60px; background: ${employee.statusDetails.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-left: 15px; box-shadow: 0 4px 15px ${employee.statusDetails.color}40;">
                                            ${employee.statusDetails.icon}
                                        </div>
                                        <div>
                                            <h4 style="color: var(--oud-gold); margin: 0; font-size: 1.2rem; font-weight: bold;">${employee.name}</h4>
                                            <p style="color: var(--oud-cream); margin: 3px 0; font-size: 1rem; font-weight: 600;">${employee.code}</p>
                                            <p style="color: var(--oud-bronze); margin: 0; font-size: 0.9rem;">${employee.department}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                        <div style="text-align: center; padding: 10px; background: ${employee.statusDetails.color}15; border-radius: 8px; border: 1px solid ${employee.statusDetails.color}30;">
                                            <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">الحالة</div>
                                            <div style="color: ${employee.statusDetails.color}; font-weight: bold; font-size: 0.9rem;">${employee.statusDetails.status}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: #10b98115; border-radius: 8px; border: 1px solid #10b981;">
                                            <div style="color: var(--oud-cream); font-size: 0.8rem; margin-bottom: 5px;">متصل منذ</div>
                                            <div style="color: #10b981; font-weight: bold; font-size: 0.9rem;">🟢 ${employee.connectionDuration} دقيقة</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="text-align: center; padding: 8px; background: var(--glass-bg); border-radius: 6px; border: 1px solid var(--oud-bronze);">
                                            <div style="color: var(--oud-cream); font-size: 0.7rem;">الوردية</div>
                                            <div style="color: var(--oud-gold); font-weight: bold; font-size: 0.8rem;">${employee.statusDetails.scheduledShift}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: var(--glass-bg); border-radius: 6px; border: 1px solid var(--oud-bronze);">
                                            <div style="color: var(--oud-cream); font-size: 0.7rem;">الحضور</div>
                                            <div style="color: ${employee.statusDetails.attendanceTime !== '-' ? '#10b981' : '#6b7280'}; font-weight: bold; font-size: 0.8rem;">${employee.statusDetails.attendanceTime}</div>
                                        </div>
                                    </div>
                                    
                                    ${employee.statusDetails.isLate ? `
                                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; margin-top: 10px;">
                                            <div style="color: #f59e0b; font-weight: bold; font-size: 0.8rem; text-align: center;">⚠️ متأخر</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--oud-gold);">
                            <div style="color: var(--oud-cream); font-size: 1rem;">
                                إجمالي الموظفين المتصلين: <span style="color: var(--oud-gold); font-weight: bold; font-size: 1.2rem;">${employees.length}</span>
                            </div>
                            <div style="color: var(--oud-bronze); font-size: 0.9rem; margin-top: 5px;">
                                يتم تحديث هذه البيانات تلقائياً عند تسجيل دخول/خروج الموظفين
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // إغلاق النافذة عند النقر خارجها
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            console.log(`✅ تم عرض نافذة الموظفين المتصلين للمدير (${employees.length} موظف)`);
        }

        // عرض نافذة حالة الموظفين
        function showEmployeeStatusModal(title, employees, icon) {
            const modalTitle = document.getElementById('statusModalTitle');
            const modalContent = document.getElementById('employeeStatusContent');
            
            modalTitle.innerHTML = `${icon} ${title}`;
            
            if (employees.length === 0) {
                modalContent.innerHTML = `
                    <div style="padding: 50px; text-align: center; color: var(--oud-cream);">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">${icon}</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px;">لا توجد بيانات</h3>
                        <p style="opacity: 0.8;">لا يوجد موظفين في هذه الفئة حالياً</p>
                    </div>
                `;
            } else {
                let content = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                `;
                
                employees.forEach(employee => {
                    const status = employeeStatusSystem.getEmployeeStatus(employee);
                    const dayIndex = employeeStatusSystem.getCurrentDayIndex();
                    const todayShift = employee.schedule[dayIndex];
                    
                    content += `
                        <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; border: 1px solid var(--oud-bronze); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-left: 15px;">
                                    👤
                                </div>
                                <div>
                                    <h4 style="color: var(--oud-gold); margin: 0; font-size: 1.1rem;">${employee.name}</h4>
                                    <p style="color: var(--oud-cream); margin: 2px 0; font-size: 0.9rem;">${employee.code}</p>
                                    <p style="color: var(--oud-bronze); margin: 0; font-size: 0.8rem;">${employee.department}</p>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 8px; background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem;">الحالة</div>
                                    <div style="color: ${status.color}; font-weight: bold; font-size: 0.9rem;">${status.icon} ${status.status}</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem;">الوردية</div>
                                    <div style="color: var(--oud-gold); font-weight: bold; font-size: 0.9rem;">${todayShift === 'Annual' ? '🏖️ إجازة' : todayShift === 'OFF' ? '💤 إجازة أسبوعية' : todayShift}</div>
                                </div>
                            </div>
                            
                            ${title.includes('متميزين') ? `
                                <div style="text-align: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 15px;">
                                    <div style="color: var(--oud-cream); font-size: 0.8rem;">نسبة الأداء</div>
                                    <div style="color: #10b981; font-weight: bold; font-size: 1.2rem;">${employee.performance}%</div>
                                </div>
                            ` : ''}
                            
                            <button class="oud-btn oud-btn-primary" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="viewEmployeeDetails(${employee.id}); closeModal('employeeStatusModal');">
                                <span>👁️</span> عرض التفاصيل
                            </button>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--oud-bronze);">
                            <div style="color: var(--oud-cream); font-size: 0.9rem;">
                                إجمالي: <span style="color: var(--oud-gold); font-weight: bold;">${employees.length}</span> موظف
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = content;
            openModal('employeeStatusModal');
        }

        // عرض جدولة الموظفين
        function displaySchedule() {
            const tbody = document.getElementById('scheduleTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            employeesData.forEach(employee => {
                const row = document.createElement('tr');
                
                // عمود اسم الموظف
                const nameCell = document.createElement('td');
                nameCell.className = 'employee-name';
                nameCell.textContent = employee.name;
                row.appendChild(nameCell);
                
                // أعمدة الجدولة (30 يوم لشهر أغسطس)
                for (let i = 0; i < 30; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'shift-cell';
                    const shift = employee.schedule[i] || 'OFF';
                    
                    // تطبيق الألوان حسب نوع الوردية
                    if (shift === '4-10') {
                        cell.className += ' shift-4-10';
                        cell.innerHTML = '<span class="shift-time">4-10</span><span class="shift-type">صباحي</span>';
                    } else if (shift === '9-3') {
                        cell.className += ' shift-9-3';
                        cell.innerHTML = '<span class="shift-time">9-3</span><span class="shift-type">نهاري</span>';
                    } else if (shift === '9-6') {
                        cell.className += ' shift-9-6';
                        cell.innerHTML = '<span class="shift-time">9-6</span><span class="shift-type">عادي</span>';
                    } else if (shift === '11-8') {
                        cell.className += ' shift-11-8';
                        cell.innerHTML = '<span class="shift-time">11-8</span><span class="shift-type">مسائي</span>';
                    } else if (shift === '1-10') {
                        cell.className += ' shift-1-10';
                        cell.innerHTML = '<span class="shift-time">1-10</span><span class="shift-type">ليلي</span>';
                    } else if (shift === 'Annual') {
                        cell.className += ' shift-annual';
                        cell.innerHTML = '<span class="shift-time">🏖️</span><span class="shift-type">إجازة</span>';
                    } else {
                        cell.className += ' shift-off';
                        cell.innerHTML = '<span class="shift-time">💤</span><span class="shift-type">إجازة أسبوعية</span>';
                    }
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            });
        }

        // فتح/إغلاق الشريط الجانبي
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // إغلاق الشريط الجانبي
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // دالة التنقل المحسنة
        function navigateToSection(section, element) {
            // منع السلوك الافتراضي للرابط
            event.preventDefault();
            
            // التحقق من تسجيل الدخول
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً! 🔐', 'error');
                return;
            }
            
            // التحقق من الصلاحيات
            if (!currentUser.permissions.includes(section)) {
                showNotification('ليس لديك صلاحية للوصول إلى هذا القسم! 🚫', 'error');
                return;
            }
            
            // إزالة الفئة النشطة من جميع العناصر
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            
            // إضافة الفئة النشطة للعنصر المحدد
            element.classList.add('active');
            
            // تبديل القسم
            switchSection(section + '-section');
            
            // تحديث البيانات حسب القسم
            if (section === 'attendance') {
                updateAttendanceStats();
            } else if (section === 'reports') {
                updateLateReports();
            } else if (section === 'employees') {
                updateEmployeeTable();
            } else if (section === 'schedule') {
                displaySchedule();
            } else if (section === 'maqsam') {
                updateMaqsamDisplay();
            }
            
            // إغلاق الشريط الجانبي
            closeSidebar();
            
            // تسجيل التنقل في الكونسول فقط
            console.log(`✅ تم الانتقال إلى ${getTitleForSection(section)}`);
        }

        // الحصول على عنوان القسم
        function getTitleForSection(section) {
            const titles = {
                'dashboard': 'لوحة التحكم',
                'schedule': 'جدولة الموظفين',
                'employees': 'إدارة الموظفين',
                'attendance': 'سجل الحضور',
                'reports': 'التقارير',
                'settings': 'الإعدادات'
            };
            return titles[section] || 'القسم';
        }

        // دالة الدخول السريع للاختبار
        function quickLogin(username) {
            console.log('🚀 دخول سريع:', username);
            
            // ملء الحقول تلقائياً
            document.getElementById('username').value = username;
            document.getElementById('password').value = '123';
            
            // تشغيل تسجيل الدخول
            const loginForm = document.getElementById('loginForm');
            const event = new Event('submit');
            loginForm.dispatchEvent(event);
        }

        // تسجيل الدخول المبسط والمحسن
        function login(event) {
            event.preventDefault();
            
            console.log('🔐 محاولة تسجيل دخول...');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            console.log('📝 البيانات المدخلة:', { username, password });
            console.log('🔍 المستخدمين المتاحين:', Object.keys(users));
            
            // التحقق من صحة البيانات
            if (!username || !password) {
                errorDiv.textContent = 'يرجى إدخال اسم المستخدم وكلمة المرور';
                errorDiv.style.display = 'block';
                return;
            }
            
            // تحديث زر تسجيل الدخول
            const loginBtn = document.querySelector('.login-btn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span style="margin-left: 8px;">⏳</span> جاري التحقق...';
            
            // التحقق المباشر من البيانات
            const user = users[username];
            
            console.log('👤 فحص المستخدم:', username);
            console.log('🔍 المستخدم موجود:', user ? 'نعم' : 'لا');
            if (user) {
                console.log('🔑 كلمة المرور المدخلة:', password);
                console.log('🔑 كلمة المرور المحفوظة:', user.password);
                console.log('✅ تطابق كلمة المرور:', user.password === password ? 'نعم' : 'لا');
                console.log('🟢 الحساب مفعل:', user.isActive ? 'نعم' : 'لا');
            }
            
            // التحقق من صحة البيانات
            if (user && user.password === password && user.isActive) {
                    // نجح تسجيل الدخول
                    loginAttempts = 0;
                    
                    // تحديث حالة المستخدم - متصل وفعال مع طابع زمني دقيق
                    user.lastLogin = new Date().toISOString();
                    user.isOnline = true;
                    user.loginCount = (user.loginCount || 0) + 1;
                    user.connectionStatus = 'متصل';
                    user.lastActivity = new Date().toISOString();
                    
                    currentUser = {
                        username: username,
                        ...user,
                        loginTime: new Date().toISOString()
                    };
                    
                    // حفظ الجلسة
                    sessionManager.saveSession(currentUser);
                    
                    // تسجيل نشاط تسجيل الدخول (آمن)
                    console.log(`✅ تسجيل دخول ناجح: ${user.name} (${user.code}) في ${new Date().toLocaleString('ar-SA')}`);
                    console.log(`🟢 ${user.name} متصل الآن - الحالة: ${user.isOnline ? 'متصل' : 'غير متصل'}`);
                    
                    // تحديث نظام تتبع الاتصال الفوري مع إشعار المدير
                    connectionTracker.updateUserStatus(username, true);
                    
                    // تفعيل الموظف في مقسم (محاكاة)
                    if (user.maqsamAgentId) {
                        console.log(`📞 تفعيل الموظف في مقسم: ${username}`);
                    }
                    
                    // إخفاء شاشة تسجيل الدخول وإظهار المحتوى الرئيسي
                    const loginContainer = document.getElementById('loginContainer');
                    const mainContent = document.getElementById('mainContent');
                    
                    if (loginContainer) {
                        loginContainer.classList.add('hidden');
                        console.log('🔐 تم إخفاء شاشة تسجيل الدخول');
                    }
                    
                    if (mainContent) {
                        mainContent.style.display = 'block';
                        mainContent.style.visibility = 'visible';
                        mainContent.style.opacity = '1';
                        console.log('📱 تم إظهار المحتوى الرئيسي');
                    }
                    
                    // تحديث واجهة المستخدم حسب الصلاحيات
                    setTimeout(() => {
                        updateUIForUser();
                        
                        // إظهار قسم الموظفين النشطين للمدير فقط
                        if (currentUser.role === 'مدير') {
                            const activeSection = document.getElementById('activeEmployeesSection');
                            if (activeSection) {
                                activeSection.style.display = 'block';
                            }
                            
                            // تحديث عرض الموظفين النشطين
                            setTimeout(() => {
                                preciseLoginTracker.updateActiveEmployeesDisplay();
                            }, 500);
                        }
                    }, 100);
                    
                    // إشعار فوري لجميع المديرين المتصلين (محاكاة للعمل على الإنترنت)
                    if (currentUser.role === 'موظف') {
                        setTimeout(() => {
                            // محاكاة إرسال إشعار للمديرين عبر الإنترنت
                            console.log(`📡 إرسال إشعار للمديرين: ${currentUser.name} دخل للنظام`);
                            
                            // في التطبيق الحقيقي، سيتم إرسال هذا عبر WebSocket أو Server-Sent Events
                            const notificationData = {
                                type: 'employee_login',
                                employee: {
                                    name: currentUser.name,
                                    code: currentUser.code,
                                    department: currentUser.department
                                },
                                timestamp: new Date().toISOString(),
                                loginTime: new Date().toLocaleTimeString('ar-SA', { hour12: false })
                            };
                            
                            // محاكاة استقبال الإشعار من الخادم
                            setTimeout(() => {
                                if (currentUser && currentUser.role === 'مدير') {
                                    connectionTracker.notifyAdminOfStatusChange(username, true);
                                }
                            }, 1000);
                        }, 500);
                    }
                    
                    // تسجيل الحضور التلقائي للموظفين فقط (ليس المدير) - مع تحديث فوري
                    if (currentUser.role === 'موظف') {
                        console.log(`👤 معالجة تسجيل دخول الموظف: ${currentUser.name}`);
                        
                        // تسجيل الحضور فوراً
                        const attendanceResult = attendanceSystem.autoCheckIn(username);
                        console.log(`📋 نتيجة تسجيل الحضور:`, attendanceResult);
                        
                        if (attendanceResult.success) {
                            // عرض نافذة تأكيد الحضور
                            setTimeout(() => {
                                showAttendanceConfirmation(attendanceResult);
                            }, 800);
                            console.log(`✅ ${currentUser.name}: ${attendanceResult.message}`);
                        } else if (attendanceResult.alreadyCheckedIn) {
                            console.log(`ℹ️ ${currentUser.name}: تم تسجيل حضورك مسبقاً اليوم`);
                        } else {
                            console.log(`ℹ️ ${currentUser.name}: ${attendanceResult.message || 'لم يتم تسجيل الحضور'}`);
                        }
                        
                        // تحديث الإحصائيات فوراً مع حالة الاتصال
                        setTimeout(() => {
                            updateStats();
                            updateAttendanceStats();
                            connectionTracker.broadcastUpdate();
                            console.log(`📊 تم تحديث الإحصائيات للموظف: ${currentUser.name}`);
                        }, 200);
                        
                    } else {
                        // تسجيل دخول المدير
                        console.log(`👨‍💼 تم تسجيل دخول المدير: ${currentUser.name}`);
                        setTimeout(() => {
                            updateStats();
                            updateAttendanceStats();
                            connectionTracker.broadcastUpdate();
                            
                            // عرض الموظفين الحاضرين للمدير فقط
                            showPresentEmployeesForAdmin();
                            console.log(`📊 تم تحديث الإحصائيات للمدير: ${currentUser.name}`);
                        }, 500);
                    }
                    
                    errorDiv.style.display = 'none';
                    
                    // إعادة تعيين النموذج
                    document.getElementById('loginForm').reset();
                    
                } else {
                    // فشل تسجيل الدخول
                    console.warn(`❌ محاولة دخول فاشلة`);
                    console.warn('❌ السبب:', !user ? 'مستخدم غير موجود' : !user.isActive ? 'حساب غير مفعل' : 'كلمة مرور خاطئة');
                    
                    let errorMessage = '';
                    
                    // التحقق من سبب الفشل
                    if (!user) {
                        errorMessage = 'اسم المستخدم غير صحيح';
                    } else if (!user.isActive) {
                        errorMessage = 'هذا الحساب غير مفعل، يرجى التواصل مع الإدارة';
                    } else if (user.password !== password) {
                        errorMessage = 'كلمة المرور غير صحيحة';
                    } else {
                        errorMessage = 'خطأ في تسجيل الدخول';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    
                    // تأثير اهتزاز للخطأ
                    const loginCard = document.querySelector('.login-card');
                    if (loginCard) {
                        loginCard.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            loginCard.style.animation = '';
                        }, 500);
                    }
                    
                    // مسح كلمة المرور
                    document.getElementById('password').value = '';
                }
                
                // إعادة تفعيل الزر
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span style="margin-left: 8px;">🚀</span> تسجيل الدخول';
        }

        // تحديث واجهة المستخدم حسب الصلاحيات
        function updateUIForUser() {
            console.log(`🔧 تحديث واجهة المستخدم للمستخدم: ${currentUser.name} (${currentUser.role})`);
            
            const menuItems = document.querySelectorAll('.menu-item');
            console.log(`📋 عدد عناصر القائمة: ${menuItems.length}`);
            console.log(`🔑 صلاحيات المستخدم:`, currentUser.permissions);
            
            menuItems.forEach(item => {
                const section = item.getAttribute('data-section');
                if (currentUser.permissions.includes(section)) {
                    item.style.display = 'flex';
                    console.log(`✅ إظهار قسم: ${section}`);
                } else {
                    item.style.display = 'none';
                    console.log(`❌ إخفاء قسم: ${section}`);
                }
            });
            
            // إخفاء/إظهار أزرار المدير
            const addEmployeeBtn = document.getElementById('addEmployeeBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            if (currentUser.role === 'مدير') {
                if (addEmployeeBtn) addEmployeeBtn.style.display = 'inline-flex';
                if (exportBtn) exportBtn.style.display = 'inline-flex';
                console.log('👨‍💼 إظهار أزرار المدير');
            } else {
                if (addEmployeeBtn) addEmployeeBtn.style.display = 'none';
                if (exportBtn) exportBtn.style.display = 'none';
                console.log('👤 إخفاء أزرار المدير للموظف');
            }
            
            // التأكد من إظهار المحتوى الرئيسي للموظفين
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'block';
                console.log('📱 تم إظهار المحتوى الرئيسي');
            }
            
            // التنقل التلقائي للموظفين إلى قسم الحضور
            if (currentUser.role === 'موظف') {
                setTimeout(() => {
                    const attendanceMenuItem = document.querySelector('.menu-item[data-section="attendance"]');
                    if (attendanceMenuItem) {
                        navigateToSection('attendance', attendanceMenuItem);
                        console.log('🎯 تم التنقل التلقائي لقسم الحضور للموظف');
                    }
                }, 500);
            }
            
            // تحديث عنوان المستخدم
            const userInfo = document.createElement('div');
            userInfo.innerHTML = `
                <div style="padding: 15px 25px; border-top: 1px solid var(--oud-gold); margin-top: 20px;">
                    <div style="color: var(--oud-gold); font-weight: 600; margin-bottom: 5px;">
                        ${currentUser.role === 'مدير' ? '👨‍💼' : '👤'} ${currentUser.name}
                    </div>
                    <div style="color: var(--oud-cream); font-size: 0.9rem; opacity: 0.8;">
                        ${currentUser.role} - ${currentUser.code}
                    </div>
                    <div style="color: var(--oud-gold); font-size: 0.8rem; margin-top: 5px;">
                        🟢 متصل ونشط
                    </div>
                    ${currentUser.role === 'مدير' ? `
                        <div style="color: var(--oud-amber); font-size: 0.8rem; margin-top: 3px;">
                            🔑 صلاحيات كاملة
                        </div>
                    ` : ''}
                    <button onclick="logout()" style="
                        margin-top: 10px;
                        padding: 8px 15px;
                        background: var(--oud-bronze);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cairo', sans-serif;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='var(--oud-brown)'" onmouseout="this.style.background='var(--oud-bronze)'">
                        🚪 تسجيل الخروج
                    </button>
                </div>
            `;
            
            document.querySelector('.sidebar-menu').appendChild(userInfo);
        }

        // تسجيل الخروج المحسن والدقيق مع تأكيد مرئي
        function logout() {
            if (!currentUser) {
                console.warn('❌ لا يوجد مستخدم مسجل دخول');
                showNotification('لا يوجد مستخدم مسجل دخول! 🚫', 'error');
                return;
            }
            
            // إنشاء نافذة تأكيد مخصصة للجوال
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal active';
            confirmModal.style.zIndex = '5000';
            confirmModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div style="padding: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">🚪</div>
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px;">تأكيد تسجيل الخروج</h3>
                        <p style="color: var(--oud-cream); margin-bottom: 30px; line-height: 1.6;">
                            هل أنت متأكد من تسجيل الخروج؟<br>
                            <span style="color: var(--oud-bronze); font-size: 0.9rem;">سيتم تسجيل الانصراف تلقائياً إذا لم تكن مسجل انصراف</span>
                        </p>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="this.closest('.modal').remove()" class="oud-btn oud-btn-secondary" style="min-width: 120px;">
                                <span>❌</span> إلغاء
                            </button>
                            <button onclick="confirmLogout(); this.closest('.modal').remove()" class="oud-btn" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; min-width: 120px;">
                                <span>✅</span> تأكيد الخروج
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // إغلاق النافذة عند النقر خارجها
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.remove();
                }
            });
        }
        
        // دالة تأكيد الخروج الفعلية مع نظام الاتصال المتقدم
        function confirmLogout() {
            console.log(`🚪 بدء عملية تسجيل الخروج للمستخدم: ${currentUser.name}`);
            
            // 1. تسجيل الانصراف التلقائي للموظفين فقط
            if (currentUser.role === 'موظف') {
                const userAttendance = attendanceSystem.getUserAttendance(currentUser.username);
                console.log(`📋 فحص حالة الحضور للموظف ${currentUser.name}:`, userAttendance);
                
                if (userAttendance && userAttendance.checkIn && !userAttendance.checkOut) {
                    console.log(`⏰ تسجيل انصراف تلقائي للموظف ${currentUser.name}`);
                    const result = attendanceSystem.checkOut(currentUser.username);
                    if (result.success) {
                        console.log(`✅ تم تسجيل الانصراف التلقائي بنجاح - ساعات العمل: ${result.data.workingHours}`);
                        showNotification(`تم تسجيل الانصراف تلقائياً - ${result.data.workingHours} ساعة عمل ✅`, 'success');
                    } else {
                        console.error(`❌ فشل في تسجيل الانصراف التلقائي:`, result.message);
                    }
                } else if (userAttendance && userAttendance.checkOut) {
                    console.log(`ℹ️ الموظف ${currentUser.name} مسجل انصراف مسبقاً`);
                } else {
                    console.log(`ℹ️ الموظف ${currentUser.name} لم يسجل حضور اليوم`);
                }
            }
            
            // 2. تحديث حالة المستخدم - غير متصل باستخدام نظام تتبع الاتصال
            connectionTracker.updateUserStatus(currentUser.username, false);
            console.log(`🔌 تحديث حالة ${currentUser.name} إلى غير متصل`);
            
            // إيقاف الموظف في مقسم (محاكاة)
            if (currentUser.maqsamAgentId) {
                console.log(`📞 إيقاف الموظف في مقسم: ${currentUser.username}`);
            }
            
            // 3. بث التحديث فوراً لجميع الواجهات
            connectionTracker.broadcastUpdate();
            
            // 3. حفظ معلومات المستخدم قبل المسح
            const loggedOutUser = {
                name: currentUser.name,
                username: currentUser.username,
                role: currentUser.role,
                code: currentUser.code,
                logoutTime: new Date().toISOString()
            };
            
            // 4. مسح الجلسة من التخزين المحلي
            sessionManager.clearSession();
            console.log(`🗑️ تم مسح جلسة ${loggedOutUser.name}`);
            
            // 5. إعادة تعيين المتغير العام
            currentUser = null;
            
            // 6. إخفاء المحتوى الرئيسي وإظهار شاشة تسجيل الدخول
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginContainer').classList.remove('hidden');
            
            // 7. مسح نموذج تسجيل الدخول
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
            
            // 8. إزالة معلومات المستخدم من الشريط الجانبي
            const userInfoElements = document.querySelectorAll('.sidebar-menu > div');
            userInfoElements.forEach(element => {
                if (element.innerHTML.includes('متصل ونشط') || element.innerHTML.includes('تسجيل الخروج')) {
                    element.remove();
                }
            });
            
            // 9. إغلاق الشريط الجانبي والنوافذ المنبثقة
            closeSidebar();
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // 10. تحديث الإحصائيات فوراً لإظهار التغيير
            setTimeout(() => {
                updateStats();
                updateAttendanceStats();
                console.log(`📊 تم تحديث الإحصائيات بعد خروج ${loggedOutUser.name}`);
            }, 300);
            
            // 11. تسجيل الخروج في الكونسول فقط
            console.log(`✅ اكتملت عملية تسجيل الخروج للمستخدم: ${loggedOutUser.name} في ${new Date().toLocaleString('ar-SA')}`);
            
            // 12. تسجيل تفصيلي في الكونسول
            console.log('📋 ملخص عملية تسجيل الخروج:');
            console.log(`   👤 المستخدم: ${loggedOutUser.name} (${loggedOutUser.code})`);
            console.log(`   🕐 وقت الخروج: ${new Date(loggedOutUser.logoutTime).toLocaleString('ar-SA')}`);
            console.log(`   💼 الدور: ${loggedOutUser.role}`);
            console.log(`   🔌 حالة الاتصال: غير متصل`);
            console.log(`   📱 واجهة المستخدم: تم إعادة تعيينها لشاشة تسجيل الدخول`);
        }

        // تأثير الاهتزاز للخطأ
        function addShakeAnimation() {
            const shakeKeyframes = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            
            const style = document.createElement('style');
            style.textContent = shakeKeyframes;
            document.head.appendChild(style);
        }

        // فتح النافذة المنبثقة مع تأثيرات متحركة
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            // إضافة تأثير صوتي بصري
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                modalContent.style.animation = 'modalBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            }, 100);
        }

        // إغلاق النافذة المنبثقة مع تأثيرات متحركة
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('.modal-content');
            
            // تأثير الإغلاق
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in-out';
            
            setTimeout(() => {
                modal.classList.remove('active');
                modalContent.style.animation = '';
            }, 300);
        }
        
        // تبديل الأقسام مع تأثيرات انتقالية
        function switchSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إظهار القسم المحدد
            setTimeout(() => {
                const targetSection = document.getElementById(sectionId);
                targetSection.classList.add('active');
                targetSection.classList.add('page-transition');
                
                // إزالة فئة الانتقال بعد انتهاء الحركة
                setTimeout(() => {
                    targetSection.classList.remove('page-transition');
                }, 600);
            }, 100);
            
            // تحديث عنوان الصفحة
            updatePageTitle(sectionId);
        }
        
        // تحديث عنوان الصفحة
        function updatePageTitle(sectionId) {
            const titles = {
                'dashboard-section': 'لوحة التحكم الرئيسية',
                'schedule-section': 'جدولة الموظفين',
                'employees-section': 'إدارة الموظفين',
                'attendance-section': 'سجل الحضور والانصراف',
                'reports-section': 'التقارير والإحصائيات',
                'settings-section': 'إعدادات النظام'
            };
            
            const pageTitle = document.getElementById('pageTitle');
            pageTitle.textContent = titles[sectionId] || 'نظام إدارة الحضور والانصراف';
            
            // تأثير تحديث العنوان
            pageTitle.style.animation = 'titleUpdate 0.5s ease-in-out';
            setTimeout(() => {
                pageTitle.style.animation = '';
            }, 500);
        }

        // إضافة موظف جديد
        function addEmployee(event) {
            event.preventDefault();
            
            const name = document.getElementById('employeeName').value;
            const employeeId = document.getElementById('employeeId').value;
            const department = document.getElementById('employeeDepartment').value;
            
            const newEmployee = {
                id: employeesData.length + 1,
                name: name,
                code: employeeId,
                department: department,
                schedule: Array(20).fill('OFF') // جدولة افتراضية
            };
            
            employeesData.push(newEmployee);
            displaySchedule();
            updateStats();
            closeModal('addEmployeeModal');
            
            // إعادة تعيين النموذج
            document.getElementById('addEmployeeForm').reset();
            
            // إشعار نجاح
            showNotification('تم إضافة الموظف بنجاح! ✅', 'success');
        }

        // عرض تفاصيل الموظف
        function viewEmployeeDetails(employeeId) {
            const employee = employeesData.find(emp => emp.id === employeeId);
            if (!employee) return;

            const detailsContent = document.getElementById('employeeDetailsContent');
            
            // حساب إحصائيات الموظف
            const workDays = employee.schedule.filter(shift => shift !== 'OFF' && shift !== 'Annual').length;
            const offDays = employee.schedule.filter(shift => shift === 'OFF').length;
            const vacationDays = employee.schedule.filter(shift => shift === 'Annual').length;
            
            detailsContent.innerHTML = `
                <div style="padding: 20px;">
                    <!-- Employee Header -->
                    <div style="display: flex; align-items: center; margin-bottom: 30px; padding: 20px; background: var(--glass-bg); border-radius: 15px; border: 1px solid var(--oud-gold);">
                        <div style="width: 80px; height: 80px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-left: 20px;">
                            👤
                        </div>
                        <div>
                            <h2 style="color: var(--oud-gold); margin: 0; font-size: 1.8rem;">${employee.name}</h2>
                            <p style="color: var(--oud-cream); margin: 5px 0; font-size: 1.1rem;">${employee.code}</p>
                            <p style="color: var(--oud-bronze); margin: 0; font-size: 1rem;">${employee.department}</p>
                        </div>
                    </div>

                    <!-- Employee Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="stat-card" style="padding: 15px;">
                            <span class="stat-icon" style="font-size: 1.5rem;">📅</span>
                            <div class="stat-number" style="font-size: 1.5rem;">${workDays}</div>
                            <div class="stat-label">أيام عمل</div>
                        </div>
                        <div class="stat-card" style="padding: 15px;">
                            <span class="stat-icon" style="font-size: 1.5rem;">💤</span>
                            <div class="stat-number" style="font-size: 1.5rem;">${offDays}</div>
                            <div class="stat-label">أيام راحة</div>
                        </div>
                        <div class="stat-card" style="padding: 15px;">
                            <span class="stat-icon" style="font-size: 1.5rem;">🏖️</span>
                            <div class="stat-number" style="font-size: 1.5rem;">${vacationDays}</div>
                            <div class="stat-label">أيام إجازة</div>
                        </div>
                        <div class="stat-card" style="padding: 15px;">
                            <span class="stat-icon" style="font-size: 1.5rem;">⭐</span>
                            <div class="stat-number" style="font-size: 1.5rem;">95%</div>
                            <div class="stat-label">معدل الأداء</div>
                        </div>
                    </div>

                    <!-- Employee Schedule Preview -->
                    <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; border: 1px solid var(--oud-bronze);">
                        <h3 style="color: var(--oud-gold); margin-bottom: 15px; display: flex; align-items: center;">
                            <span style="margin-left: 10px;">📋</span>
                            جدولة الموظف - الأسبوع الحالي
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                            ${employee.schedule.slice(0, 7).map((shift, index) => {
                                const days = ['الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد', 'الاثنين'];
                                let shiftClass = 'shift-off';
                                let shiftText = '💤 راحة';
                                
                                if (shift === '4-10') {
                                    shiftClass = 'shift-4-10';
                                    shiftText = '4-10<br>صباحي';
                                } else if (shift === '9-3') {
                                    shiftClass = 'shift-9-3';
                                    shiftText = '9-3<br>نهاري';
                                } else if (shift === '9-6') {
                                    shiftClass = 'shift-9-6';
                                    shiftText = '9-6<br>عادي';
                                } else if (shift === '11-8') {
                                    shiftClass = 'shift-11-8';
                                    shiftText = '11-8<br>مسائي';
                                } else if (shift === '1-10') {
                                    shiftClass = 'shift-1-10';
                                    shiftText = '1-10<br>ليلي';
                                } else if (shift === 'Annual') {
                                    shiftClass = 'shift-annual';
                                    shiftText = '🏖️<br>إجازة';
                                }
                                
                                return `
                                    <div style="text-align: center; padding: 10px; border-radius: 8px;" class="${shiftClass}">
                                        <div style="font-size: 0.8rem; margin-bottom: 5px; opacity: 0.9;">${days[index]}</div>
                                        <div style="font-size: 0.9rem; font-weight: bold;">${shiftText}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button class="oud-btn oud-btn-primary" onclick="editEmployeeSchedule(${employee.id})">
                            <span>📝</span> تعديل الجدولة
                        </button>
                        <button class="oud-btn oud-btn-secondary" onclick="viewEmployeeReports(${employee.id})">
                            <span>📊</span> التقارير
                        </button>
                        <button class="oud-btn oud-btn-primary" onclick="contactEmployee(${employee.id})">
                            <span>📞</span> التواصل
                        </button>
                    </div>
                </div>
            `;
            
            openModal('employeeDetailsModal');
        }

        // وظائف إضافية للموظف
        function editEmployeeSchedule(employeeId) {
            showNotification('ميزة تعديل الجدولة قيد التطوير 🚧', 'info');
        }

        function viewEmployeeReports(employeeId) {
            showNotification('ميزة التقارير قيد التطوير 📊', 'info');
        }

        function contactEmployee(employeeId) {
            showNotification('ميزة التواصل قيد التطوير 📞', 'info');
        }

        // عرض نافذة تأكيد الحضور
        function showAttendanceConfirmation(attendanceResult) {
            const modalContent = document.getElementById('attendanceModalContent');
            const now = new Date();
            const currentTime = now.toLocaleTimeString('ar-SA', { hour12: false });
            const currentDate = now.toLocaleDateString('ar-SA');
            
            modalContent.innerHTML = `
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">
                        ${attendanceResult.isLate ? '⚠️' : '✅'}
                    </div>
                    <h3 style="color: var(--oud-gold); margin-bottom: 15px;">
                        ${attendanceResult.isLate ? 'تم تسجيل الحضور - متأخر' : 'تم تسجيل الحضور بنجاح'}
                    </h3>
                    
                    <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid var(--oud-gold);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: right;">
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">الموظف:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${currentUser.name}</div>
                            </div>
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">الكود:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${currentUser.employeeId}</div>
                            </div>
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">التاريخ:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${currentDate}</div>
                            </div>
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">وقت الحضور:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${attendanceResult.data.checkIn}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${attendanceResult.isLate ? `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 10px; padding: 15px; margin: 20px 0;">
                            <div style="color: #f59e0b; font-weight: bold; margin-bottom: 5px;">⚠️ تنبيه تأخير</div>
                            <div style="color: var(--oud-cream); font-size: 0.9rem;">
                                وقت العمل الرسمي: 09:00 صباحاً<br>
                                يرجى الالتزام بمواعيد العمل المحددة
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 10px; padding: 15px; margin: 20px 0;">
                            <div style="color: #10b981; font-weight: bold; margin-bottom: 5px;">✅ حضور في الوقت المحدد</div>
                            <div style="color: var(--oud-cream); font-size: 0.9rem;">
                                شكراً لك على الالتزام بمواعيد العمل
                            </div>
                        </div>
                    `}
                    
                    <button class="oud-btn oud-btn-primary" onclick="closeModal('attendanceModal')" style="margin-top: 20px;">
                        <span>👍</span> موافق
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                openModal('attendanceModal');
            }, 500);
        }

        // تحديث إحصائيات الحضور
        function updateAttendanceStats() {
            const regularEmployeesCount = employeesData.filter(emp => {
                const username = Object.keys(users).find(u => users[u].name === emp.name);
                return username && users[username].role !== 'مدير';
            }).length;
            
            // حساب الحاضرين والمتأخرين من البيانات الفعلية
            let actualPresentCount = 0;
            let lateCount = 0;
            let workingCount = 0;
            
            const todayData = attendanceSystem.attendanceData[attendanceSystem.currentDate] || {};
            
            // فحص كل موظف (بدون المدير)
            employeesData.forEach(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                if (username && users[username].role !== 'مدير') {
                    const attendance = todayData[username];
                    const isLoggedIn = users[username].isOnline;
                    
                    // تحديد إذا كان يوم عمل
                    const dayIndex = employeeStatusSystem.getCurrentDayIndex();
                    const todayShift = employee.schedule[dayIndex];
                    const isWorkDay = todayShift !== 'OFF' && todayShift !== 'Annual';
                    
                    // الموظف حاضر إذا سجل حضور أو مسجل دخول في يوم عمل
                    const hasAttendance = attendance && attendance.checkIn;
                    if (hasAttendance || (isLoggedIn && isWorkDay)) {
                        actualPresentCount++;
                    }
                    
                    // فحص التأخير والعمل الحالي
                    if (attendance) {
                        if (attendance.isLate) lateCount++;
                        if (attendance.checkIn && !attendance.checkOut) workingCount++;
                    }
                }
            });
            
            document.getElementById('totalEmployeesCount').textContent = regularEmployeesCount;
            document.getElementById('presentCount').textContent = actualPresentCount;
            document.getElementById('lateCount').textContent = lateCount;
            document.getElementById('workingCount').textContent = workingCount;
            
            // تحديث حالة المستخدم الحالي
            updateUserAttendanceStatus();
            
            // تحديث جدول الحضور اليومي
            updateTodayAttendanceTable();
        }

        // تحديث حالة حضور المستخدم الحالي
        function updateUserAttendanceStatus() {
            if (!currentUser) return;
            
            const userAttendance = attendanceSystem.getUserAttendance(currentUser.username);
            const statusContainer = document.getElementById('userAttendanceStatus');
            
            if (!userAttendance) {
                statusContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="color: var(--oud-cream); opacity: 0.7;">لا توجد بيانات حضور لهذا اليوم</div>
                    </div>
                `;
                return;
            }
            
            const statusColor = userAttendance.status === 'حاضر' ? '#10b981' : 
                               userAttendance.status === 'منصرف' ? '#3b82f6' : '#6b7280';
            
            statusContainer.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h3 style="color: var(--oud-gold); margin: 0;">حالة حضورك اليوم</h3>
                        <span style="background: ${statusColor}; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                            ${userAttendance.status}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: var(--glass-bg); border-radius: 10px; padding: 15px; border: 1px solid var(--oud-bronze);">
                            <div style="color: var(--oud-cream); margin-bottom: 5px;">وقت الحضور</div>
                            <div style="color: var(--oud-gold); font-weight: bold; font-size: 1.2rem;">
                                ${userAttendance.checkIn || 'لم يتم التسجيل'}
                                ${userAttendance.isLate ? ' <span style="color: #f59e0b;">⚠️</span>' : ''}
                            </div>
                        </div>
                        
                        <div style="background: var(--glass-bg); border-radius: 10px; padding: 15px; border: 1px solid var(--oud-bronze);">
                            <div style="color: var(--oud-cream); margin-bottom: 5px;">وقت الانصراف</div>
                            <div style="color: var(--oud-gold); font-weight: bold; font-size: 1.2rem;">
                                ${userAttendance.checkOut || 'لم يتم التسجيل'}
                                ${userAttendance.earlyLeave ? ' <span style="color: #f59e0b;">⚠️</span>' : ''}
                            </div>
                        </div>
                        
                        <div style="background: var(--glass-bg); border-radius: 10px; padding: 15px; border: 1px solid var(--oud-bronze);">
                            <div style="color: var(--oud-cream); margin-bottom: 5px;">ساعات العمل</div>
                            <div style="color: var(--oud-gold); font-weight: bold; font-size: 1.2rem;">
                                ${userAttendance.workingHours > 0 ? userAttendance.workingHours + ' ساعة' : 'جاري الحساب...'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // تحديث أزرار الإجراءات
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            
            if (userAttendance.checkIn && !userAttendance.checkOut) {
                checkInBtn.style.display = 'none';
                checkOutBtn.style.display = 'inline-flex';
            } else if (userAttendance.checkOut) {
                checkInBtn.style.display = 'none';
                checkOutBtn.style.display = 'none';
            } else {
                checkInBtn.style.display = 'inline-flex';
                checkOutBtn.style.display = 'none';
            }
        }

        // تحديث جدول الحضور اليومي
        function updateTodayAttendanceTable() {
            const tbody = document.getElementById('todayAttendanceTableBody');
            if (!tbody) return;
            
            const todayData = attendanceSystem.attendanceData[attendanceSystem.currentDate] || {};
            
            tbody.innerHTML = '';
            
            // فلترة الموظفين لاستبعاد المدير
            const regularEmployees = employeesData.filter(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                return username && users[username].role !== 'مدير';
            });
            
            regularEmployees.forEach(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                const user = users[username];
                
                // الحصول على بيانات الحضور أو إنشاء بيانات افتراضية
                let attendance = todayData[username];
                
                // إذا لم توجد بيانات حضور، تحديد الحالة حسب الاتصال والجدولة
                if (!attendance) {
                    const dayIndex = employeeStatusSystem.getCurrentDayIndex();
                    const todayShift = employee.schedule[dayIndex];
                    const isWorkDay = todayShift !== 'OFF' && todayShift !== 'Annual';
                    const isOnline = user && user.isOnline;
                    
                    // إذا كان متصل في يوم عمل، اعتبره حاضر
                    if (isOnline && isWorkDay) {
                        attendance = {
                            checkIn: user.lastLogin ? new Date(user.lastLogin).toLocaleTimeString('ar-SA', { hour12: false }) : 'متصل الآن',
                            checkOut: null,
                            status: 'حاضر',
                            workingHours: 0,
                            isLate: false,
                            earlyLeave: false,
                            notes: ['متصل في النظام']
                        };
                    } else {
                        attendance = {
                            checkIn: null,
                            checkOut: null,
                            status: isWorkDay ? 'غائب' : (todayShift === 'Annual' ? 'إجازة سنوية' : 'إجازة أسبوعية'),
                            workingHours: 0,
                            isLate: false,
                            earlyLeave: false,
                            notes: []
                        };
                    }
                }
                
                const row = document.createElement('tr');
                
                const statusColor = attendance.status === 'حاضر' ? '#10b981' : 
                                   attendance.status === 'منصرف' ? '#3b82f6' : 
                                   attendance.status === 'إجازة سنوية' ? '#f97316' :
                                   attendance.status === 'إجازة أسبوعية' ? '#6b7280' : '#ef4444';
                
                row.innerHTML = `
                    <td style="font-weight: bold;">${user.name}</td>
                    <td>${attendance.checkIn || '-'} ${attendance.isLate ? '<span style="color: #f59e0b;">⚠️</span>' : ''}</td>
                    <td>${attendance.checkOut || '-'} ${attendance.earlyLeave ? '<span style="color: #f59e0b;">⚠️</span>' : ''}</td>
                    <td>${attendance.workingHours > 0 ? attendance.workingHours + ' ساعة' : '-'}</td>
                    <td><span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${attendance.status}</span></td>
                    <td style="font-size: 0.8rem;">${attendance.notes && attendance.notes.length > 0 ? attendance.notes[attendance.notes.length - 1] : '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // تسجيل حضور يدوي
        function manualCheckIn() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const result = attendanceSystem.checkIn(currentUser.username);
            
            if (result.success) {
                console.log(`✅ ${result.message}`);
                showAttendanceConfirmation(result);
                updateAttendanceStats();
            } else {
                console.log(`ℹ️ ${result.message}`);
            }
        }

        // فتح نافذة تسجيل الانصراف
        function openCheckOutModal() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const userAttendance = attendanceSystem.getUserAttendance(currentUser.username);
            if (!userAttendance || !userAttendance.checkIn) {
                showNotification('يجب تسجيل الحضور أولاً', 'error');
                return;
            }
            
            if (userAttendance.checkOut) {
                showNotification('تم تسجيل الانصراف مسبقاً اليوم', 'info');
                return;
            }
            
            openModal('checkOutModal');
        }

        // تأكيد تسجيل الانصراف
        function confirmCheckOut() {
            const result = attendanceSystem.checkOut(currentUser.username);
            
            closeModal('checkOutModal');
            
            if (result.success) {
                console.log(`✅ ${result.message}`);
                
                // عرض ملخص يوم العمل
                setTimeout(() => {
                    showWorkDaySummary(result);
                }, 500);
                
                updateAttendanceStats();
            } else {
                console.log(`❌ ${result.message}`);
            }
        }

        // عرض ملخص يوم العمل
        function showWorkDaySummary(checkOutResult) {
            const modalContent = document.getElementById('attendanceModalContent');
            const userAttendance = checkOutResult.data;
            
            modalContent.innerHTML = `
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">🎯</div>
                    <h3 style="color: var(--oud-gold); margin-bottom: 15px;">ملخص يوم العمل</h3>
                    
                    <div style="background: var(--glass-bg); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid var(--oud-gold);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: right;">
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">وقت الحضور:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${userAttendance.checkIn}</div>
                            </div>
                            <div>
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">وقت الانصراف:</div>
                                <div style="color: var(--oud-gold); font-weight: bold;">${userAttendance.checkOut}</div>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <div style="color: var(--oud-cream); margin-bottom: 5px;">إجمالي ساعات العمل:</div>
                                <div style="color: var(--oud-gold); font-weight: bold; font-size: 1.5rem;">${userAttendance.workingHours} ساعة</div>
                            </div>
                        </div>
                    </div>
                    
                    ${userAttendance.workingHours >= 8 ? `
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 10px; padding: 15px; margin: 20px 0;">
                            <div style="color: #10b981; font-weight: bold; margin-bottom: 5px;">✅ يوم عمل مكتمل</div>
                            <div style="color: var(--oud-cream); font-size: 0.9rem;">
                                تم إكمال ساعات العمل المطلوبة بنجاح
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 10px; padding: 15px; margin: 20px 0;">
                            <div style="color: #f59e0b; font-weight: bold; margin-bottom: 5px;">⚠️ ساعات عمل ناقصة</div>
                            <div style="color: var(--oud-cream); font-size: 0.9rem;">
                                ساعات العمل المطلوبة: 8 ساعات يومياً
                            </div>
                        </div>
                    `}
                    
                    <div style="margin-top: 20px;">
                        <div style="color: var(--oud-cream); margin-bottom: 10px;">شكراً لك على عملك اليوم! 🙏</div>
                        <button class="oud-btn oud-btn-primary" onclick="closeModal('attendanceModal')">
                            <span>👍</span> إنهاء
                        </button>
                    </div>
                </div>
            `;
            
            openModal('attendanceModal');
        }

        // نظام تتبع التأخير المتقدم مع البيانات الفعلية
        const lateTrackingSystem = {
            // الأكواد الوظيفية الفعلية
            employeeCodes: {
                'badr': '7177',
                'saad': '5472',
                'hussein': '9058',
                'ahmed': '12694',
                'yazeed': '10449',
                'noura': '15104'
            },
            
            // بيانات التأخير الشهرية (يناير - فبراير 2025)
            lateData: {
                '2025-01-20': { 'badr': { lateMinutes: 12.9 } },
                '2025-01-21': { 'ahmed': { lateMinutes: 35 } },
                '2025-01-22': { 'saad': { lateMinutes: 15.1 } },
                '2025-01-25': { 'saad': { lateMinutes: 10.6 } },
                '2025-01-29': { 'yazeed': { lateMinutes: 34.3 } },
                '2025-01-30': { 'yazeed': { lateMinutes: 1 } },
                '2025-01-31': { 'yazeed': { lateMinutes: 121.1 } },
                '2025-02-01': { 'noura': { lateMinutes: 2.9 } },
                '2025-02-02': { 'hussein': { lateMinutes: 16.6 } },
                '2025-02-03': { 'noura': { lateMinutes: 86.6 } },
                '2025-02-11': { 'saad': { lateMinutes: 40.3 } },
                '2025-02-16': { 'hussein': { lateMinutes: 10.6 } },
                '2025-02-17': { 'saad': { lateMinutes: 45.6 }, 'hussein': { lateMinutes: 13.3 } },
                '2025-02-18': { 'hussein': { lateMinutes: 12.4 }, 'ahmed': { lateMinutes: 53.5 } }
            },
            
            // الحصول على إجمالي التأخير الشهري للموظف
            getMonthlyLateTotal(username) {
                let total = 0;
                Object.values(this.lateData).forEach(dayData => {
                    if (dayData[username]) {
                        total += dayData[username].lateMinutes;
                    }
                });
                return total;
            },
            
            // الحصول على تفاصيل التأخير للموظف
            getEmployeeLateDetails(username) {
                const details = {};
                Object.keys(this.lateData).forEach(date => {
                    const dayData = this.lateData[date];
                    if (dayData[username]) {
                        details[date] = dayData[username];
                    }
                });
                return details;
            },
            
            // توليد بيانات تجريبية إضافية
            generateSampleData() {
                // البيانات موجودة بالفعل في lateData
                console.log('📊 بيانات التأخير الفعلية محملة');
            }
        };

        // نظام إدارة الحضور والانصراف المتقدم
        const attendanceSystem = {
            // البيانات المحفوظة في التخزين المحلي
            attendanceData: JSON.parse(localStorage.getItem('oudAttendanceData') || '{}'),
            currentDate: new Date().toISOString().split('T')[0],
            
            // تهيئة النظام
            init() {
                this.checkNewDay();
                this.loadTodayData();
                console.log('🎯 نظام الحضور جاهز:', this.currentDate);
            },
            
            // فحص اليوم الجديد وتصفير العدادات
            checkNewDay() {
                const today = new Date().toISOString().split('T')[0];
                if (this.currentDate !== today) {
                    console.log('🌅 يوم جديد! تصفير العدادات...');
                    this.currentDate = today;
                    
                    // إنشاء بيانات جديدة لليوم الجديد
                    if (!this.attendanceData[today]) {
                        this.attendanceData[today] = {};
                    }
                    
                    this.saveData();
                    this.loadTodayData();
                }
            },
            
            // تحميل بيانات اليوم الحالي
            loadTodayData() {
                if (!this.attendanceData[this.currentDate]) {
                    this.attendanceData[this.currentDate] = {};
                }
            },
            
            // حفظ البيانات في التخزين المحلي
            saveData() {
                try {
                    localStorage.setItem('oudAttendanceData', JSON.stringify(this.attendanceData));
                    console.log('💾 تم حفظ بيانات الحضور');
                } catch (error) {
                    console.error('❌ خطأ في حفظ البيانات:', error);
                }
            },
            
            // تسجيل الحضور التلقائي الذكي
            autoCheckIn(username) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ar-SA', { hour12: false });
                const todayData = this.attendanceData[this.currentDate];
                
                // التحقق من وجود تسجيل مسبق
                if (todayData[username] && todayData[username].checkIn) {
                    return {
                        success: false,
                        message: 'تم تسجيل الحضور مسبقاً اليوم',
                        alreadyCheckedIn: true,
                        data: todayData[username]
                    };
                }
                
                // التحقق من الجدولة - هل الموظف مجدول للعمل اليوم؟
                const employee = employeesData.find(emp => {
                    const empUsername = Object.keys(users).find(u => users[u].name === emp.name);
                    return empUsername === username;
                });
                
                if (employee) {
                    const dayIndex = employeeStatusSystem.getCurrentDayIndex();
                    const todayShift = employee.schedule[dayIndex];
                    
                    // إذا كان في إجازة أو راحة، لا يسجل حضور
                    if (todayShift === 'Annual' || todayShift === 'OFF') {
                        return {
                            success: false,
                            message: todayShift === 'Annual' ? 'أنت في إجازة اليوم 🏖️' : 'اليوم إجازة أسبوعية لك 💤',
                            isOffDay: true
                        };
                    }
                }
                
                // تحديد حالة التأخير (بعد 9:15 صباحاً)
                const isLate = now.getHours() > 9 || (now.getHours() === 9 && now.getMinutes() > 15);
                
                // حساب دقائق التأخير الدقيقة
                let lateMinutes = 0;
                if (isLate) {
                    const workStartTime = new Date(now);
                    workStartTime.setHours(9, 15, 0, 0); // 9:15 صباحاً
                    lateMinutes = Math.max(0, (now - workStartTime) / (1000 * 60));
                }
                
                // إنشاء سجل الحضور المتقدم
                const attendanceRecord = {
                    checkIn: timeString,
                    checkOut: null,
                    status: 'حاضر',
                    isLate: isLate,
                    lateMinutes: lateMinutes,
                    earlyLeave: false,
                    workingHours: 0,
                    notes: [isLate ? `تأخير ${lateMinutes.toFixed(1)} دقيقة` : 'حضور في الوقت المحدد'],
                    loginTime: now.toISOString(),
                    scheduledShift: employee ? employee.schedule[employeeStatusSystem.getCurrentDayIndex()] : 'غير محدد'
                };
                
                // حفظ البيانات
                todayData[username] = attendanceRecord;
                this.saveData();
                
                console.log(`✅ تسجيل حضور ذكي: ${username} في ${timeString} ${isLate ? `(متأخر ${lateMinutes.toFixed(1)} دقيقة)` : ''}`);
                
                return {
                    success: true,
                    message: isLate ? `تم تسجيل الحضور - متأخر ${lateMinutes.toFixed(1)} دقيقة ⚠️` : 'تم تسجيل الحضور بنجاح ✅',
                    isLate: isLate,
                    lateMinutes: lateMinutes,
                    data: attendanceRecord
                };
            },
            
            // تسجيل الحضور اليدوي
            checkIn(username) {
                return this.autoCheckIn(username);
            },
            
            // تسجيل الانصراف
            checkOut(username) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ar-SA', { hour12: false });
                const todayData = this.attendanceData[this.currentDate];
                
                if (!todayData[username] || !todayData[username].checkIn) {
                    return {
                        success: false,
                        message: 'يجب تسجيل الحضور أولاً'
                    };
                }
                
                if (todayData[username].checkOut) {
                    return {
                        success: false,
                        message: 'تم تسجيل الانصراف مسبقاً'
                    };
                }
                
                // حساب ساعات العمل
                const checkInTime = new Date(`${this.currentDate}T${todayData[username].checkIn}`);
                const checkOutTime = now;
                const workingHours = Math.round((checkOutTime - checkInTime) / (1000 * 60 * 60) * 10) / 10;
                
                // تحديد الانصراف المبكر (قبل 6:00 مساءً)
                const earlyLeave = now.getHours() < 18;
                
                // تحديث السجل
                todayData[username].checkOut = timeString;
                todayData[username].status = 'منصرف';
                todayData[username].workingHours = workingHours;
                todayData[username].earlyLeave = earlyLeave;
                
                if (earlyLeave) {
                    todayData[username].notes.push('انصراف مبكر');
                }
                
                this.saveData();
                
                console.log(`🏠 تسجيل انصراف: ${username} في ${timeString} - ${workingHours} ساعة`);
                
                return {
                    success: true,
                    message: earlyLeave ? 'تم تسجيل الانصراف - مبكر ⚠️' : 'تم تسجيل الانصراف بنجاح ✅',
                    earlyLeave: earlyLeave,
                    data: todayData[username]
                };
            },
            
            // الحصول على بيانات المستخدم
            getUserAttendance(username) {
                const todayData = this.attendanceData[this.currentDate];
                return todayData ? todayData[username] : null;
            },
            
            // الحصول على الإحصائيات اليومية
            getDailyStats() {
                const todayData = this.attendanceData[this.currentDate] || {};
                const totalUsers = Object.keys(users).length;
                
                let present = 0;
                let late = 0;
                let working = 0;
                
                Object.values(todayData).forEach(record => {
                    if (record.checkIn) {
                        present++;
                        if (record.isLate) late++;
                        if (record.checkIn && !record.checkOut) working++;
                    }
                });
                
                return {
                    total: totalUsers,
                    present: present,
                    absent: totalUsers - present,
                    late: late,
                    working: working
                };
            },
            
            // مسح بيانات قديمة (الاحتفاظ بآخر 30 يوم)
            cleanOldData() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];
                
                Object.keys(this.attendanceData).forEach(date => {
                    if (date < cutoffDate) {
                        delete this.attendanceData[date];
                    }
                });
                
                this.saveData();
                console.log('🧹 تم تنظيف البيانات القديمة');
            }
        };

        // نظام الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-family: 'Cairo', sans-serif;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // نظام تصدير Excel المتقدم
        const excelExportSystem = {
            // حساب إحصائيات التأخير والغياب الشهرية
            calculateMonthlyLateStats() {
                const monthlyStats = {};
                
                // تجميع بيانات كل موظف (باستثناء المدير)
                employeesData.forEach(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name && users[u].role !== 'مدير');
                    if (!username) return;
                    
                    monthlyStats[username] = {
                        name: employee.name,
                        code: lateTrackingSystem.employeeCodes[username] || employee.code,
                        department: employee.department,
                        salary: employee.salary,
                        totalLateMinutes: 0,
                        lateDays: 0,
                        absentDays: 0,
                        lateDeduction: 0,
                        absentDeduction: 0,
                        totalDeduction: 0,
                        netSalary: 0,
                        lateDetails: [],
                        absentDetails: []
                    };
                });
                
                // حساب التأخيرات من البيانات الفعلية
                Object.keys(lateTrackingSystem.lateData).forEach(date => {
                    const dayData = lateTrackingSystem.lateData[date];
                    Object.keys(dayData).forEach(username => {
                        if (monthlyStats[username]) {
                            const lateMinutes = dayData[username].lateMinutes;
                            monthlyStats[username].totalLateMinutes += lateMinutes;
                            monthlyStats[username].lateDays++;
                            monthlyStats[username].lateDetails.push({
                                date: date,
                                minutes: lateMinutes
                            });
                        }
                    });
                });
                
                // حساب الغيابات من جدولة العمل
                const currentDayIndex = employeeStatusSystem.getCurrentDayIndex();
                employeesData.forEach(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name && users[u].role !== 'مدير');
                    if (!username || !monthlyStats[username]) return;
                    
                    // فحص الأيام المجدولة للعمل
                    for (let i = 0; i < Math.min(currentDayIndex + 1, 30); i++) {
                        const shift = employee.schedule[i];
                        if (shift !== 'OFF' && shift !== 'Annual') {
                            // يوم عمل مجدول
                            const dateObj = new Date('2025-08-01');
                            dateObj.setDate(dateObj.getDate() + i);
                            const dateStr = dateObj.toISOString().split('T')[0];
                            
                            // التحقق من الحضور
                            const attendanceData = attendanceSystem.attendanceData[dateStr];
                            const hasAttendance = attendanceData && attendanceData[username] && attendanceData[username].checkIn;
                            const hasLateRecord = lateTrackingSystem.lateData[dateStr] && lateTrackingSystem.lateData[dateStr][username];
                            
                            if (!hasAttendance && !hasLateRecord) {
                                // غائب
                                monthlyStats[username].absentDays++;
                                monthlyStats[username].absentDetails.push({
                                    date: dateStr,
                                    shift: shift
                                });
                            }
                        }
                    }
                });
                
                // حساب الخصومات النهائية
                Object.keys(monthlyStats).forEach(username => {
                    const stats = monthlyStats[username];
                    
                    // خصم التأخير: 10 ريال لكل دقيقة
                    stats.lateDeduction = Math.round(stats.totalLateMinutes * 10);
                    
                    // خصم الغياب: 200 ريال لكل يوم غياب
                    stats.absentDeduction = stats.absentDays * 200;
                    
                    // إجمالي الخصومات
                    stats.totalDeduction = stats.lateDeduction + stats.absentDeduction;
                    
                    // صافي الراتب
                    stats.netSalary = stats.salary - stats.totalDeduction;
                });
                
                return monthlyStats;
            },
            
            // تصدير تقرير Excel شامل مع التأخيرات والغيابات
            exportDetailedExcel() {
                const monthlyStats = this.calculateMonthlyLateStats();
                const currentDate = new Date().toLocaleDateString('ar-SA');
                
                // إنشاء محتوى CSV متقدم
                let csvContent = '\uFEFF'; // BOM for UTF-8
                
                // ملخص الشركة
                csvContent += `تقرير التأخيرات والغيابات الشامل - نخبة العود\n`;
                csvContent += `تاريخ التقرير: ${currentDate}\n`;
                csvContent += `عدد الموظفين: ${Object.keys(monthlyStats).length}\n\n`;
                
                // الملخص العام
                csvContent += `الملخص العام\n`;
                csvContent += `الموظف,الكود الوظيفي,القسم,الراتب الأساسي,أيام التأخير,إجمالي دقائق التأخير,خصم التأخير,أيام الغياب,خصم الغياب,إجمالي الخصومات,صافي الراتب\n`;
                
                Object.values(monthlyStats).forEach(stats => {
                    csvContent += `${stats.name},${stats.code},${stats.department},${stats.salary},${stats.lateDays},${Math.round(stats.totalLateMinutes)},${stats.lateDeduction},${stats.absentDays},${stats.absentDeduction},${stats.totalDeduction},${stats.netSalary}\n`;
                });
                
                csvContent += `\n\n`;
                
                // تفاصيل التأخيرات لكل موظف
                Object.values(monthlyStats).forEach(stats => {
                    if (stats.lateDetails.length > 0) {
                        csvContent += `تفاصيل التأخيرات - ${stats.name} (${stats.code})\n`;
                        csvContent += `التاريخ,دقائق التأخير,خصم التأخير (ريال)\n`;
                        
                        stats.lateDetails.forEach(detail => {
                            const deduction = Math.round(detail.minutes * 10);
                            csvContent += `${detail.date},${detail.minutes},${deduction}\n`;
                        });
                        
                        csvContent += `إجمالي دقائق التأخير: ${Math.round(stats.totalLateMinutes)}\n`;
                        csvContent += `إجمالي خصم التأخير: ${stats.lateDeduction} ريال\n\n`;
                    }
                });
                
                // تفاصيل الغيابات لكل موظف
                Object.values(monthlyStats).forEach(stats => {
                    if (stats.absentDetails.length > 0) {
                        csvContent += `تفاصيل الغيابات - ${stats.name} (${stats.code})\n`;
                        csvContent += `التاريخ,الوردية المجدولة,خصم الغياب (ريال)\n`;
                        
                        stats.absentDetails.forEach(detail => {
                            csvContent += `${detail.date},${detail.shift},200\n`;
                        });
                        
                        csvContent += `إجمالي أيام الغياب: ${stats.absentDays}\n`;
                        csvContent += `إجمالي خصم الغياب: ${stats.absentDeduction} ريال\n\n`;
                    }
                });
                
                // الإحصائيات النهائية
                const totalSalaries = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.salary, 0);
                const totalLateDeductions = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.lateDeduction, 0);
                const totalAbsentDeductions = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.absentDeduction, 0);
                const totalDeductions = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.totalDeduction, 0);
                const netSalaries = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.netSalary, 0);
                
                csvContent += `الإحصائيات النهائية\n`;
                csvContent += `إجمالي الرواتب الأساسية: ${totalSalaries} ريال\n`;
                csvContent += `إجمالي خصومات التأخير: ${totalLateDeductions} ريال\n`;
                csvContent += `إجمالي خصومات الغياب: ${totalAbsentDeductions} ريال\n`;
                csvContent += `إجمالي الخصومات: ${totalDeductions} ريال\n`;
                csvContent += `صافي الرواتب: ${netSalaries} ريال\n`;
                csvContent += `نسبة الخصومات: ${((totalDeductions / totalSalaries) * 100).toFixed(2)}%\n`;
                
                // تنزيل الملف
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `تقرير_التأخيرات_والغيابات_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                return monthlyStats;
            },
            
            // تصدير تقرير مبسط
            exportSimpleSchedule() {
                let csvContent = '\uFEFF';
                csvContent += "الاسم,الكود,القسم,";
                
                // إضافة عناوين التواريخ لشهر أغسطس 2025
                for (let i = 1; i <= 30; i++) {
                    csvContent += `8/${i}/2025,`;
                }
                csvContent += "\n";
                
                // إضافة أسماء الأيام
                csvContent += ",,,";
                const days = ['الجمعة', 'السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                days.forEach(day => {
                    csvContent += `${day},`;
                });
                csvContent += "\n";
                
                // إضافة بيانات الموظفين
                employeesData.forEach(emp => {
                    csvContent += `${emp.name},${emp.code},${emp.department},`;
                    emp.schedule.forEach(shift => {
                        csvContent += `${shift},`;
                    });
                    csvContent += "\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `جدولة_الموظفين_أغسطس_2025.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        
        // دالة تصدير البيانات المحدثة والمحسنة
        function exportData() {
            console.log('🔄 محاولة تصدير البيانات...');
            console.log('👤 المستخدم الحالي:', currentUser);
            
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً! 🔐', 'error');
                return;
            }
            
            if (currentUser.role !== 'مدير') {
                showNotification('هذه الميزة متاحة للمدير فقط! 🚫', 'error');
                return;
            }
            
            console.log('✅ تم التحقق من الصلاحيات - عرض نافذة التصدير');
            
            // عرض خيارات التصدير
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '3000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">📊 تصدير التقارير</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 30px;">
                        <div style="display: grid; gap: 20px;">
                            <button class="oud-btn oud-btn-primary" onclick="exportDetailedReport(); this.closest('.modal').remove();" style="padding: 20px; font-size: 1.1rem;">
                                <span style="font-size: 1.5rem; margin-left: 10px;">📈</span>
                                <div>
                                    <div style="font-weight: bold;">تقرير شامل مع الحسابات</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">يشمل التأخير والخصومات والرواتب</div>
                                </div>
                            </button>
                            
                            <button class="oud-btn oud-btn-secondary" onclick="exportSimpleReport(); this.closest('.modal').remove();" style="padding: 20px; font-size: 1.1rem;">
                                <span style="font-size: 1.5rem; margin-left: 10px;">📅</span>
                                <div>
                                    <div style="font-weight: bold;">جدولة الموظفين</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">جدولة العمل فقط</div>
                                </div>
                            </button>
                            
                            <button class="oud-btn oud-btn-primary" onclick="exportLateReport(); this.closest('.modal').remove();" style="padding: 20px; font-size: 1.1rem;">
                                <span style="font-size: 1.5rem; margin-left: 10px;">⏰</span>
                                <div>
                                    <div style="font-weight: bold;">تقرير التأخيرات</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">تفاصيل التأخير للموظفين</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // إضافة حدث إغلاق النافذة عند النقر خارجها
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            console.log('📊 عرض خيارات التصدير');
        }
        
        function exportDetailedReport() {
            console.log('📊 تصدير التقرير الشامل...');
            try {
                const stats = excelExportSystem.exportDetailedExcel();
                
                // تسجيل نجاح التصدير
                console.log('📊 تم تصدير التقرير الشامل بنجاح!');
                
                // عرض إحصائيات في الكونسول
                setTimeout(() => {
                    const totalDeductions = Object.values(stats).reduce((sum, s) => sum + s.lateDeduction, 0);
                    console.log(`💰 إجمالي خصومات التأخير: ${totalDeductions} ريال`);
                }, 2000);
            } catch (error) {
                console.error('❌ خطأ في تصدير التقرير:', error);
            }
        }
        
        function exportSimpleReport() {
            console.log('📅 تصدير جدولة الموظفين...');
            try {
                excelExportSystem.exportSimpleSchedule();
                console.log('📅 تم تصدير جدولة الموظفين بنجاح!');
            } catch (error) {
                console.error('❌ خطأ في تصدير الجدولة:', error);
            }
        }
        
        // تصدير جدول التأخيرات المطابق للمطلوب
        function exportLateTrackingReport() {
            if (!currentUser || currentUser.role !== 'مدير') {
                showNotification('هذه الميزة متاحة للمدير فقط! 🚫', 'error');
                return;
            }
            
            let csvContent = '\uFEFF'; // BOM for UTF-8
            
            // عنوان التقرير
            csvContent += 'جدول تتبع التأخيرات - نخبة العود\n';
            csvContent += `تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}\n\n`;
            
            // رأس الجدول
            csvContent += 'الاسم,الكود الوظيفي,';
            
            // إضافة التواريخ (يناير - فبراير 2025)
            const dates = [
                '1/20/2025', '1/21/2025', '1/22/2025', '1/23/2025', '1/24/2025', '1/25/2025', '1/26/2025',
                '1/27/2025', '1/28/2025', '1/29/2025', '1/30/2025', '1/31/2025',
                '2/1/2025', '2/2/2025', '2/3/2025', '2/4/2025', '2/5/2025', '2/6/2025', '2/7/2025',
                '2/8/2025', '2/9/2025', '2/10/2025', '2/11/2025', '2/12/2025', '2/13/2025', '2/14/2025',
                '2/15/2025', '2/16/2025', '2/17/2025', '2/18/2025', '2/19/2025'
            ];
            
            const days = [
                'الاثنين', 'الثلاثاء', 'الاربعاء', 'الخميس', 'الجمعة', 'السبت', 'الاحد',
                'الاثنين', 'الثلات', 'الاربعاء', 'الخميس', 'الجمعة',
                'السبت', 'الاحد', 'الاثنين', 'الثلاثاء', 'الاربعاء', 'الخميس', 'الجمعة',
                'السبت', 'الاحد', 'الاثنين', 'الثلات', 'الاربعاء', 'الخميس', 'الجمعة',
                'السبت', 'الاحد', 'الاثنين', 'الثلاثاء', 'الاربعاء'
            ];
            
            dates.forEach((date, index) => {
                csvContent += `${date} ${days[index]},`;
            });
            csvContent += 'اجمالي التأخيرات بالدقائق\n';
            
            // بيانات الموظفين
            const employeeData = [
                { username: 'badr.nasser', name: 'بدر ناصر', code: '7177', data: [
                    '', '12.9', '', '', 'OFF', 'OFF', '', '', '', '', '', 'OFF',
                    'OFF', '', '', 'OFF', 'OFF', 'OFF', '', '', '', '', '', 'OFF',
                    'OFF', '', '', '', '', '', 'OFF'
                ]},
                { username: 'saad.sanbal', name: 'سعد سنبل', code: '5472', data: [
                    '', '', '15.1', 'OFF', 'OFF', '10.6', '', '', '', '', 'OFF', 'OFF',
                    '', 'OFF', 'OFF', '', '', '', 'OFF', 'OFF', '', '', '40.3', '',
                    '', 'OFF', 'OFF', '', '45.6', '', ''
                ]},
                { username: 'hussein.harbi', name: 'حسين الحربي', code: '9058', data: [
                    '', '', '', '', '', '', '', 'OFF', 'OFF', '', '', '',
                    '', '16.6', 'OFF', 'OFF', '', '', 'OFF', 'OFF', 'OFF', 'OFF', '', '',
                    '', 'OFF', 'OFF', '10.6', '13.3', '12.4', ''
                ]},
                { username: 'ahmed.anzi', name: 'احمد العنزي', code: '12694', data: [
                    '', '35', '', '', 'OFF', 'OFF', '', '', '', '', '', 'OFF',
                    'OFF', 'OFF', 'OFF', '', 'OFF', 'OFF', '', '', 'OFF', 'OFF', '', 'OFF',
                    'OFF', '', '', 'OFF', 'OFF', '53.5', 'OFF'
                ]},
                { username: 'yazeed.naimi', name: 'يزيد النعيمي', code: '10449', data: [
                    '', '', '', '', '', '', 'OFF', '', '', '34.3', '1', '121.1',
                    'OFF', '', '', '', 'OFF', '', '', '', '', '', 'OFF', 'OFF',
                    '', '', '', '', '', 'OFF', 'OFF'
                ]},
                { username: 'noura.faisal', name: 'نورة فيصل', code: '15104', data: [
                    '', '', 'OFF', 'OFF', '', '', '', '', '', 'OFF', 'OFF', 'OFF',
                    '2.9', '', '86.6', '', '', 'OFF', 'OFF', '', '', '', '', '',
                    'OFF', 'OFF', '', '', '', '', 'OFF'
                ]}
            ];
            
            employeeData.forEach(emp => {
                csvContent += `${emp.name},${emp.code},`;
                emp.data.forEach(value => {
                    csvContent += `${value || ''},`;
                });
                
                // حساب الإجمالي
                const total = lateTrackingSystem.getMonthlyLateTotal(emp.username);
                csvContent += `${total}\n`;
            });
            
            // تنزيل الملف
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `جدول_تتبع_التأخيرات_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('⏰ تم تصدير جدول التأخيرات بنجاح!');
        }

        // نظام تقارير التأخير الذكي المتقدم
        const lateReportingSystem = {
            // حساب إحصائيات التأخير من بيانات الحضور الفعلية
            calculateLateStats() {
                let totalLateMinutes = 0;
                let employeesWithLate = 0;
                let lateIncidents = 0;
                const employeeLateData = {};
                
                // فحص بيانات الحضور لجميع الأيام
                Object.keys(attendanceSystem.attendanceData).forEach(date => {
                    const dayData = attendanceSystem.attendanceData[date];
                    
                    Object.keys(dayData).forEach(username => {
                        const attendance = dayData[username];
                        if (attendance.isLate && attendance.checkIn) {
                            // حساب دقائق التأخير
                            const checkInTime = new Date(`${date}T${attendance.checkIn}`);
                            const workStartTime = new Date(`${date}T09:15:00`); // 9:15 هو الحد المسموح
                            const lateMinutes = Math.max(0, (checkInTime - workStartTime) / (1000 * 60));
                            
                            if (!employeeLateData[username]) {
                                employeeLateData[username] = {
                                    totalMinutes: 0,
                                    incidents: 0,
                                    lastLateDate: null,
                                    details: []
                                };
                            }
                            
                            employeeLateData[username].totalMinutes += lateMinutes;
                            employeeLateData[username].incidents++;
                            employeeLateData[username].lastLateDate = date;
                            employeeLateData[username].details.push({
                                date: date,
                                minutes: lateMinutes,
                                checkIn: attendance.checkIn
                            });
                            
                            totalLateMinutes += lateMinutes;
                            lateIncidents++;
                        }
                    });
                });
                
                employeesWithLate = Object.keys(employeeLateData).length;
                const avgLatePerEmployee = employeesWithLate > 0 ? 
                    (totalLateMinutes / employeesWithLate).toFixed(1) : 0;
                
                return {
                    totalLateMinutes: totalLateMinutes.toFixed(1),
                    employeesWithLate,
                    lateIncidents,
                    avgLatePerEmployee,
                    employeeLateData
                };
            },
            
            // تحديث جدول تقارير التأخير
            updateLateReportTable() {
                const tbody = document.getElementById('lateReportTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                const lateStats = this.calculateLateStats();
                
                // فلترة الموظفين لاستبعاد المدير
                const regularEmployees = employeesData.filter(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    return username && users[username].role !== 'مدير';
                });
                
                regularEmployees.forEach(employee => {
                    const username = Object.keys(users).find(u => users[u].name === employee.name);
                    const lateData = lateStats.employeeLateData[username] || {
                        totalMinutes: 0,
                        incidents: 0,
                        lastLateDate: null
                    };
                    
                    const row = document.createElement('tr');
                    
                    // تلوين الصف حسب مستوى التأخير
                    let rowStyle = '';
                    if (lateData.totalMinutes > 60) {
                        rowStyle = 'background: rgba(239, 68, 68, 0.1);'; // أحمر للتأخير الكبير
                    } else if (lateData.totalMinutes > 30) {
                        rowStyle = 'background: rgba(245, 158, 11, 0.1);'; // أصفر للتأخير المتوسط
                    } else if (lateData.totalMinutes > 0) {
                        rowStyle = 'background: rgba(59, 130, 246, 0.1);'; // أزرق للتأخير القليل
                    } else {
                        rowStyle = 'background: rgba(16, 185, 129, 0.1);'; // أخضر لعدم التأخير
                    }
                    
                    row.style.cssText = rowStyle;
                    
                    const statusColor = lateData.totalMinutes > 30 ? '#ef4444' : 
                                       lateData.totalMinutes > 0 ? '#f59e0b' : '#10b981';
                    const statusText = lateData.totalMinutes > 30 ? 'يحتاج متابعة' : 
                                      lateData.totalMinutes > 0 ? 'مقبول' : 'ممتاز';
                    
                    row.innerHTML = `
                        <td style="font-weight: bold;">${employee.name}</td>
                        <td>${employee.code}</td>
                        <td style="font-weight: bold; color: ${lateData.totalMinutes > 0 ? '#ef4444' : '#10b981'};">
                            ${lateData.totalMinutes.toFixed(1)} دقيقة
                        </td>
                        <td>${lateData.incidents}</td>
                        <td>${lateData.lastLateDate ? new Date(lateData.lastLateDate).toLocaleDateString('ar-SA') : '-'}</td>
                        <td>
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                                ${statusText}
                            </span>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        };
        
        // تحديث تقارير التأخير
        function updateLateReports() {
            const lateStats = lateReportingSystem.calculateLateStats();
            
            // تحديث الإحصائيات
            document.getElementById('totalLateMinutes').textContent = lateStats.totalLateMinutes;
            document.getElementById('employeesWithLate').textContent = lateStats.employeesWithLate;
            document.getElementById('avgLatePerEmployee').textContent = lateStats.avgLatePerEmployee;
            document.getElementById('lateIncidentsCount').textContent = lateStats.lateIncidents;
            
            // تحديث الجدول
            lateReportingSystem.updateLateReportTable();
            
            console.log('⏰ تم تحديث تقارير التأخير!');
        }
        
        // تصدير تقرير التأخير
        function exportLateReport() {
            if (!currentUser || currentUser.role !== 'مدير') {
                showNotification('هذه الميزة متاحة للمدير فقط! 🚫', 'error');
                return;
            }
            
            const lateStats = lateReportingSystem.calculateLateStats();
            let csvContent = '\uFEFF'; // BOM for UTF-8
            
            // عنوان التقرير
            csvContent += 'تقرير التأخيرات - نخبة العود\n';
            csvContent += `تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}\n\n`;
            
            // الملخص العام
            csvContent += 'الملخص العام\n';
            csvContent += `إجمالي دقائق التأخير: ${lateStats.totalLateMinutes}\n`;
            csvContent += `عدد الموظفين المتأخرين: ${lateStats.employeesWithLate}\n`;
            csvContent += `عدد حالات التأخير: ${lateStats.lateIncidents}\n`;
            csvContent += `متوسط التأخير لكل موظف: ${lateStats.avgLatePerEmployee} دقيقة\n\n`;
            
            // تفاصيل الموظفين
            csvContent += 'الموظف,الكود,إجمالي دقائق التأخير,عدد مرات التأخير,آخر تأخير,الحالة\n';
            
            const regularEmployees = employeesData.filter(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                return username && users[username].role !== 'مدير';
            });
            
            regularEmployees.forEach(employee => {
                const username = Object.keys(users).find(u => users[u].name === employee.name);
                const lateData = lateStats.employeeLateData[username] || {
                    totalMinutes: 0,
                    incidents: 0,
                    lastLateDate: null
                };
                
                const statusText = lateData.totalMinutes > 30 ? 'يحتاج متابعة' : 
                                  lateData.totalMinutes > 0 ? 'مقبول' : 'ممتاز';
                
                csvContent += `${employee.name},${employee.code},${lateData.totalMinutes.toFixed(1)},${lateData.incidents},${lateData.lastLateDate || '-'},${statusText}\n`;
            });
            
            // تنزيل الملف
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `تقرير_التأخيرات_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('📊 تم تصدير تقرير التأخير بنجاح!');
        }
        
        // تحديث جدول تتبع التأخيرات
        function updateLateTrackingTable() {
            const tbody = document.getElementById('lateTrackingTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            employeesData.forEach(emp => {
                const totalLateMinutes = lateTrackingSystem.getMonthlyLateTotal(emp.username);
                const lateDetails = lateTrackingSystem.getEmployeeLateDetails(emp.username);
                const lateDays = Object.keys(lateDetails).filter(date => lateDetails[date].lateMinutes > 0).length;
                const deduction = Math.round(totalLateMinutes * 10);
                const netSalary = emp.salary - deduction;
                const code = lateTrackingSystem.employeeCodes[emp.username] || emp.code;
                
                const row = document.createElement('tr');
                
                // تلوين الصف حسب مستوى التأخير
                let rowColor = '';
                if (totalLateMinutes > 100) {
                    rowColor = 'background: rgba(239, 68, 68, 0.1);'; // أحمر للتأخير الكبير
                } else if (totalLateMinutes > 50) {
                    rowColor = 'background: rgba(245, 158, 11, 0.1);'; // أصفر للتأخير المتوسط
                } else if (totalLateMinutes > 0) {
                    rowColor = 'background: rgba(59, 130, 246, 0.1);'; // أزرق للتأخير القليل
                } else {
                    rowColor = 'background: rgba(16, 185, 129, 0.1);'; // أخضر لعدم التأخير
                }
                
                row.style.cssText = rowColor;
                
                row.innerHTML = `
                    <td style="font-weight: bold;">${emp.name}</td>
                    <td style="font-weight: bold; color: var(--oud-gold);">${code}</td>
                    <td style="font-weight: bold; color: ${totalLateMinutes > 0 ? '#ef4444' : '#10b981'};">
                        ${totalLateMinutes.toFixed(1)}
                    </td>
                    <td>${lateDays}</td>
                    <td style="font-weight: bold; color: ${deduction > 0 ? '#ef4444' : '#10b981'};">
                        ${deduction} ريال
                    </td>
                    <td>${emp.salary} ريال</td>
                    <td style="font-weight: bold; color: var(--oud-gold);">
                        ${netSalary} ريال
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // دوال مقسم الإضافية (محاكاة)
        function toggleAgentStatus(agentId, currentStatus) {
            console.log(`📞 تغيير حالة الوكيل ${agentId} من ${currentStatus}`);
            showNotification('ميزة مقسم قيد التطوير 📞', 'info');
        }
        
        function openMaqsamSettings() {
            showNotification('إعدادات مقسم قيد التطوير ⚙️', 'info');
        }
        
        function saveMaqsamSettings() {
            showNotification('حفظ إعدادات مقسم قيد التطوير 💾', 'info');
        }

        // إعداد الأحداث
        document.addEventListener('DOMContentLoaded', () => {
            // إضافة تأثير الاهتزاز
            addShakeAnimation();
            
            // تهيئة بيانات التأخير التجريبية
            if (Object.keys(lateTrackingSystem.lateData).length === 0) {
                lateTrackingSystem.generateSampleData();
                console.log('📊 تم تحميل بيانات التأخير التجريبية');
            }
            
            // تحميل بيانات الاتصال العالمية المحفوظة أولاً
            connectionTracker.loadGlobalConnectionData();
            
            // إعداد مراقبة التغييرات عبر الأجهزة
            connectionTracker.setupCrossDeviceMonitoring();
            
            // محاولة استرداد الجلسة المحفوظة
            const savedSession = sessionManager.restoreSession();
            if (savedSession) {
                currentUser = savedSession;
                
                // تحديث حالة المستخدم - متصل باستخدام نظام تتبع الاتصال
                connectionTracker.updateUserStatus(currentUser.username, true);
                console.log(`🔄 استرداد جلسة: ${currentUser.name} (${currentUser.role}) متصل الآن`);
                
                // إخفاء شاشة تسجيل الدخول وإظهار المحتوى الرئيسي
                const loginContainer = document.getElementById('loginContainer');
                const mainContent = document.getElementById('mainContent');
                
                if (loginContainer) {
                    loginContainer.classList.add('hidden');
                    console.log('🔐 تم إخفاء شاشة تسجيل الدخول (استرداد جلسة)');
                }
                
                if (mainContent) {
                    mainContent.style.display = 'block';
                    mainContent.style.visibility = 'visible';
                    mainContent.style.opacity = '1';
                    console.log('📱 تم إظهار المحتوى الرئيسي (استرداد جلسة)');
                }
                
                // تحديث واجهة المستخدم مع تأخير للتأكد من تحميل العناصر
                setTimeout(() => {
                    updateUIForUser();
                    console.log(`✅ تم تحديث واجهة المستخدم لـ ${currentUser.name}`);
                }, 200);
                
                // تحديث الإحصائيات فوراً لإظهار المتصلين
                setTimeout(() => {
                    updateStats();
                    updateAttendanceStats();
                }, 500);
                
                // تسجيل استرداد الجلسة في الكونسول فقط
                console.log(`🎉 مرحباً بعودتك ${currentUser.name}!`);
                
                console.log('🔄 تم استرداد الجلسة بنجاح');
            }
            
            // إصلاح مشكلة مشاركة الرابط - التأكد من عمل النظام على جميع الأجهزة
            try {
                // فحص دعم المتصفح للميزات المطلوبة
                if (!localStorage) {
                    console.warn('⚠️ التخزين المحلي غير مدعوم في هذا المتصفح');
                }
                
                // فحص دعم CSS Grid
                if (!CSS.supports('display', 'grid')) {
                    console.warn('⚠️ CSS Grid غير مدعوم - سيتم استخدام Flexbox');
                    // إضافة fallback للمتصفحات القديمة
                    const style = document.createElement('style');
                    style.textContent = `
                        .stats-container { display: flex; flex-wrap: wrap; }
                        .filters-row { display: flex; flex-wrap: wrap; }
                    `;
                    document.head.appendChild(style);
                }
                
                // فحص دعم الخطوط العربية
                const testDiv = document.createElement('div');
                testDiv.style.fontFamily = 'Cairo, sans-serif';
                testDiv.textContent = 'اختبار';
                document.body.appendChild(testDiv);
                
                setTimeout(() => {
                    const computedFont = window.getComputedStyle(testDiv).fontFamily;
                    if (!computedFont.includes('Cairo')) {
                        console.warn('⚠️ خط Cairo غير محمل - سيتم استخدام الخط الافتراضي');
                    }
                    document.body.removeChild(testDiv);
                }, 100);
                
                console.log('✅ فحص التوافق مكتمل - النظام جاهز للعمل على جميع الأجهزة');
                
            } catch (error) {
                console.error('❌ خطأ في فحص التوافق:', error);
            }
            
            // تهيئة نظام الحضور
            attendanceSystem.init();
            
            // تحديث الوقت
            updateTime();
            setInterval(updateTime, 1000);
            
            // عرض البيانات الأولية
            displaySchedule();
            updateStats();
            updateEmployeeTable();
            updateLateReports();
            
            // نظام مراقبة الاتصال الفوري والمستمر للمدير
            const realTimeMonitoring = {
                
                // مراقبة فورية كل 5 ثوان للحصول على تحديثات سريعة
                startRealTimeMonitoring() {
                    setInterval(() => {
                        if (currentUser) {
                            // تحديث النشاط للمستخدم الحالي
                            connectionTracker.updateCurrentUserActivity();
                            sessionManager.updateActivity();
                            
                            // تحديث الإحصائيات بشكل مستمر
                            updateStats();
                            updateAttendanceStats();
                            
                            // بث التحديثات الفورية
                            connectionTracker.broadcastUpdate();
                        }
                    }, 5000), // كل 5 ثوان للمراقبة الفورية
                    
                    // مراقبة أعمق كل دقيقة
                    setInterval(() => {
                        if (currentUser) {
                            // فحص الجلسات المنتهية الصلاحية
                            connectionTracker.checkExpiredSessions();
                            
                            // طباعة حالة المتصلين للمراقبة
                            const onlineUsers = connectionTracker.getOnlineUsers();
                            const onlineDetails = connectionTracker.getOnlineUsersDetails();
                            console.log(`🔄 تحديث دوري - المتصلين: ${onlineUsers.length}`);
                            onlineDetails.forEach(user => {
                                console.log(`   🟢 ${user.name} - متصل منذ ${user.connectionDuration} دقيقة`);
                            });
                            
                            // إشعار المدير بالموظفين المتصلين
                            if (currentUser.role === 'مدير' && onlineUsers.length > 0) {
                                console.log('👨‍💼 المدير متصل - تحديث بيانات الموظفين المتصلين');
                            }
                        }
                    }, 60000); // كل دقيقة للمراقبة العميقة
                },
                
                // مراقبة تغييرات الحالة في الوقت الفعلي
                watchForStatusChanges() {
                    // مراقبة تغييرات localStorage للتزامن بين التبويبات
                    window.addEventListener('storage', (e) => {
                        if (e.key === 'oudConnectionData') {
                            console.log('🔄 تم اكتشاف تغيير في بيانات الاتصال من تبويب آخر');
                            connectionTracker.loadConnectionData();
                            
                            // إشعار المدير بالتغييرات
                            if (currentUser && currentUser.role === 'مدير') {
                                setTimeout(() => {
                                    updateStats();
                                    updateAttendanceStats();
                                }, 500);
                            }
                        }
                    });
                    
                    // مراقبة تغييرات الشبكة مع مؤشر بصري
                    window.addEventListener('online', () => {
                        console.log('🌐 الاتصال بالإنترنت متاح');
                        this.showNetworkStatus(true);
                        
                        if (currentUser) {
                            connectionTracker.updateUserStatus(currentUser.username, true);
                            // مزامنة البيانات المؤجلة
                            sessionManager.syncQueuedData();
                        }
                    });
                    
                    window.addEventListener('offline', () => {
                        console.log('🌐 انقطع الاتصال بالإنترنت');
                        this.showNetworkStatus(false);
                        
                        if (currentUser) {
                            connectionTracker.updateUserStatus(currentUser.username, false);
                        }
                    });
                },

                // عرض حالة الشبكة
                showNetworkStatus(isOnline) {
                    // إزالة المؤشر السابق إن وجد
                    const existingIndicator = document.getElementById('networkIndicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                    
                    // إنشاء مؤشر حالة الشبكة
                    const indicator = document.createElement('div');
                    indicator.id = 'networkIndicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 20px;
                        background: ${isOnline ? '#10b981' : '#ef4444'};
                        color: white;
                        padding: 10px 15px;
                        border-radius: 25px;
                        font-family: 'Cairo', sans-serif;
                        font-weight: 600;
                        font-size: 0.9rem;
                        z-index: 20000;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        animation: slideInLeft 0.5s ease-out;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    `;
                    
                    indicator.innerHTML = `
                        <div style="width: 8px; height: 8px; background: white; border-radius: 50%; ${isOnline ? 'animation: pulse 2s infinite;' : ''}"></div>
                        ${isOnline ? '🌐 متصل بالإنترنت' : '📴 غير متصل بالإنترنت'}
                    `;
                    
                    document.body.appendChild(indicator);
                    
                    // إزالة المؤشر بعد 3 ثوان إذا كان متصل، أو إبقاؤه إذا كان غير متصل
                    if (isOnline) {
                        setTimeout(() => {
                            if (document.body.contains(indicator)) {
                                indicator.style.animation = 'slideOutLeft 0.3s ease-in';
                                setTimeout(() => {
                                    if (document.body.contains(indicator)) {
                                        indicator.remove();
                                    }
                                }, 300);
                            }
                        }, 3000);
                    }
                    
                    // إضافة تأثير النبض للاتصال
                    if (isOnline) {
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.5; }
                            }
                            @keyframes slideInLeft {
                                0% { transform: translateX(-100%); opacity: 0; }
                                100% { transform: translateX(0); opacity: 1; }
                            }
                            @keyframes slideOutLeft {
                                0% { transform: translateX(0); opacity: 1; }
                                100% { transform: translateX(-100%); opacity: 0; }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }
            };
            
            // بدء المراقبة الفورية
            realTimeMonitoring.startRealTimeMonitoring();
            realTimeMonitoring.watchForStatusChanges();
            
            // تهيئة نظام مقسم
            setTimeout(async () => {
                console.log('📞 بدء تهيئة نظام مقسم...');
                await maqsamIntegration.initialize();
                
                // تحديث عرض مقسم إذا كان المدير متصل
                if (currentUser && currentUser.role === 'مدير') {
                    updateMaqsamDisplay();
                }
                
                console.log('📞 تم تهيئة نظام مقسم بنجاح');
            }, 3000);
            
            // تحديث فوري للإحصائيات عند تحميل الصفحة
            setTimeout(() => {
                updateStats();
                updateAttendanceStats();
                console.log('📊 تم التحديث الفوري للإحصائيات');
            }, 1000);
            
            // أحداث تسجيل الدخول
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', login);
            }
            
            // أحداث النماذج
            const addEmployeeForm = document.getElementById('addEmployeeForm');
            if (addEmployeeForm) {
                addEmployeeForm.addEventListener('submit', addEmployee);
            }
            
            // إغلاق الشريط الجانبي عند النقر على الخلفية
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', closeSidebar);
            }
            
            // إغلاق النوافذ المنبثقة عند النقر خارجها
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // إغلاق الشريط الجانبي عند الضغط على Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeSidebar();
                    // إغلاق النوافذ المنبثقة أيضاً
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // فحص اليوم الجديد كل ساعة
            setInterval(() => {
                attendanceSystem.checkNewDay();
            }, 3600000); // كل ساعة
            
            // تنظيف البيانات القديمة كل يوم
            setInterval(() => {
                attendanceSystem.cleanOldData();
            }, 24 * 60 * 60 * 1000); // كل 24 ساعة
            
            console.log('🌟 نظام نخبة العود جاهز للعمل!');
            console.log('📅 التاريخ الحالي:', attendanceSystem.currentDate);
            console.log('👥 عدد المستخدمين:', Object.keys(users).length);
            console.log('💾 بيانات الحضور المحفوظة:', Object.keys(attendanceSystem.attendanceData).length, 'يوم');
            console.log('🔑 أسماء المستخدمين المتاحة:', Object.keys(users));
            console.log('📝 جميع كلمات المرور: 123');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9651b239f14352c7',t:'MTc1MzUwOTgzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
